{% extends "base.html" %}

{% block title %}Dashboard - polar-flow-server{% endblock %}

{% block content %}
<div class="mb-8 flex items-center justify-between">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
        <p class="text-gray-600 mt-1">Complete Polar V3 API health data</p>
    </div>
    <div class="flex items-center space-x-2">
        <a
            href="/admin/settings"
            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
        >
            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Settings
        </a>
        <form method="POST" action="/admin/logout" class="inline">
            {% if csrf_token %}<input type="hidden" name="_csrf_token" value="{{ csrf_token }}">{% endif %}
            <button
                type="submit"
                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
            >
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                Logout
            </button>
        </form>
    </div>
</div>

<!-- Key Metrics Row (Latest Values) -->
<div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-5 mb-6" id="stats-container">
    <!-- Latest HRV -->
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 overflow-hidden shadow rounded-lg">
        <div class="p-4">
            <div class="text-purple-100 text-xs font-medium uppercase">HRV (last night)</div>
            <div class="text-white text-2xl font-bold mt-1">
                {% if latest_hrv %}{{ latest_hrv|round(0) }}<span class="text-sm font-normal ml-1">ms</span>{% else %}--{% endif %}
            </div>
        </div>
    </div>

    <!-- Latest HR -->
    <div class="bg-gradient-to-br from-red-500 to-red-600 overflow-hidden shadow rounded-lg">
        <div class="p-4">
            <div class="text-red-100 text-xs font-medium uppercase">Resting HR</div>
            <div class="text-white text-2xl font-bold mt-1">
                {% if latest_hr and latest_hr.hr_avg %}{{ latest_hr.hr_avg }}<span class="text-sm font-normal ml-1">bpm</span>{% else %}--{% endif %}
            </div>
        </div>
    </div>

    <!-- Cardio Load -->
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 overflow-hidden shadow rounded-lg">
        <div class="p-4">
            <div class="text-orange-100 text-xs font-medium uppercase">7-Day Strain</div>
            <div class="text-white text-2xl font-bold mt-1">
                {% if latest_cardio and latest_cardio.strain %}{{ latest_cardio.strain|round(0) }}{% else %}--{% endif %}
            </div>
        </div>
    </div>

    <!-- Alertness -->
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 overflow-hidden shadow rounded-lg">
        <div class="p-4">
            <div class="text-blue-100 text-xs font-medium uppercase">Alertness</div>
            <div class="text-white text-2xl font-bold mt-1">
                {% if latest_alertness %}{{ latest_alertness.grade|round(1) }}<span class="text-sm font-normal ml-1">/10</span>{% else %}--{% endif %}
            </div>
        </div>
    </div>

    <!-- Sleep Score (latest) -->
    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 overflow-hidden shadow rounded-lg">
        <div class="p-4">
            <div class="text-indigo-100 text-xs font-medium uppercase">Sleep Score</div>
            <div class="text-white text-2xl font-bold mt-1">
                {% if recent_sleep and recent_sleep[0].sleep_score %}{{ recent_sleep[0].sleep_score }}<span class="text-sm font-normal ml-1">/100</span>{% else %}--{% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Today's Readiness -->
{% if recovery_status.has_data %}
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex items-start justify-between">
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
                <h2 class="text-lg font-semibold text-gray-900">Today's Readiness</h2>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                    {% if recovery_status.readiness == 'excellent' %}bg-green-100 text-green-800
                    {% elif recovery_status.readiness == 'good' %}bg-blue-100 text-blue-800
                    {% elif recovery_status.readiness == 'fair' %}bg-yellow-100 text-yellow-800
                    {% else %}bg-red-100 text-red-800{% endif %}">
                    {{ recovery_status.readiness|title }} ({{ recovery_status.readiness_score }}/100)
                </span>
            </div>
            <p class="text-gray-700 font-medium mb-3">{{ recovery_status.training_advice }}</p>
            <div class="space-y-2">
                {% for rec in recovery_status.recommendations %}
                <div class="flex items-start gap-2 text-sm text-gray-600">
                    <svg class="h-5 w-5 text-gray-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>{{ rec }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="ml-6 flex-shrink-0">
            <!-- Readiness gauge visualization -->
            <div class="w-24 h-24 relative">
                <svg class="w-24 h-24 transform -rotate-90">
                    <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                    <circle cx="48" cy="48" r="40"
                        stroke="{% if recovery_status.readiness == 'excellent' %}#22c55e{% elif recovery_status.readiness == 'good' %}#3b82f6{% elif recovery_status.readiness == 'fair' %}#eab308{% else %}#ef4444{% endif %}"
                        stroke-width="8" fill="none"
                        stroke-dasharray="{{ (recovery_status.readiness_score / 100) * 251.2 }} 251.2"
                        stroke-linecap="round"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-2xl font-bold text-gray-900">{{ recovery_status.readiness_score }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Data Record Counts -->
<div class="bg-white shadow rounded-lg p-4 mb-6">
    <div class="text-xs text-gray-500 uppercase tracking-wide mb-3">Records in Database</div>
    <!-- Core Data -->
    <div class="grid grid-cols-3 gap-3 sm:grid-cols-5 lg:grid-cols-9 mb-4">
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ sleep_count }}</div>
            <div class="text-gray-500 text-xs">nights</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ recharge_count }}</div>
            <div class="text-gray-500 text-xs">recharge</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ activity_count }}</div>
            <div class="text-gray-500 text-xs">activity days</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ exercise_count }}</div>
            <div class="text-gray-500 text-xs">workouts</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ cardio_load_count }}</div>
            <div class="text-gray-500 text-xs">cardio days</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ alertness_count }}</div>
            <div class="text-gray-500 text-xs">alertness</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ bedtime_count }}</div>
            <div class="text-gray-500 text-xs">bedtimes</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ activity_samples_count }}</div>
            <div class="text-gray-500 text-xs">samples</div>
        </div>
        <div class="text-center">
            <div class="text-gray-900 text-lg font-semibold">{{ continuous_hr_count }}</div>
            <div class="text-gray-500 text-xs">HR days</div>
        </div>
    </div>
    <!-- Biosensing & Analytics -->
    <div class="border-t border-gray-200 pt-3">
        <div class="grid grid-cols-3 gap-3 sm:grid-cols-6">
            <div class="text-center">
                <div class="text-purple-600 text-lg font-semibold">{{ spo2_count }}</div>
                <div class="text-gray-500 text-xs">SpO2</div>
            </div>
            <div class="text-center">
                <div class="text-purple-600 text-lg font-semibold">{{ ecg_count }}</div>
                <div class="text-gray-500 text-xs">ECG</div>
            </div>
            <div class="text-center">
                <div class="text-purple-600 text-lg font-semibold">{{ body_temp_count }}</div>
                <div class="text-gray-500 text-xs">body temp</div>
            </div>
            <div class="text-center">
                <div class="text-purple-600 text-lg font-semibold">{{ skin_temp_count }}</div>
                <div class="text-gray-500 text-xs">skin temp</div>
            </div>
            <div class="text-center">
                <div class="text-indigo-600 text-lg font-semibold">{{ baseline_count }}</div>
                <div class="text-gray-500 text-xs">baselines</div>
            </div>
            <div class="text-center">
                <div class="text-indigo-600 text-lg font-semibold">{{ pattern_count }}</div>
                <div class="text-gray-500 text-xs">patterns</div>
            </div>
        </div>
    </div>
</div>

<!-- API Keys Management -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-lg font-semibold text-gray-900">API Keys</h2>
            <p class="text-sm text-gray-600">Manage API keys for service-to-service authentication</p>
        </div>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
            {{ api_keys|length }} key{% if api_keys|length != 1 %}s{% endif %}
        </span>
    </div>

    {% if api_keys %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scope</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate Limit</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Used</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for key in api_keys %}
                <tr class="{% if not key.is_active %}bg-gray-50 opacity-60{% endif %}">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <code class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">{{ key.key_prefix }}...</code>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{ key.name }}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        {% if key.user_id %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            User: {{ key.user_id[:12] }}{% if key.user_id|length > 12 %}...{% endif %}
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            Service-level
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center">
                            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (key.rate_limit_remaining / key.rate_limit_requests * 100)|round }}%"></div>
                            </div>
                            <span>{{ key.rate_limit_remaining }}/{{ key.rate_limit_requests }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        {% if key.is_active %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Active
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Revoked
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                        {% if key.last_used_at %}
                        {{ key.last_used_at.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                        <span class="text-gray-400">Never</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-8">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No API keys</h3>
        <p class="mt-1 text-sm text-gray-500">API keys are created when users connect via OAuth.</p>
    </div>
    {% endif %}
</div>

<!-- Sync Scheduler Status & Control -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-lg font-semibold text-gray-900">Background Sync</h2>
            <p class="text-sm text-gray-600">Automatic sync every {{ sync_interval_minutes }} minutes</p>
        </div>
        <div class="flex items-center gap-3">
            {% if scheduler_status.is_running %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-1.5 animate-pulse"></span>
                Running
            </span>
            {% elif scheduler_status.enabled %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                Enabled (not started)
            </span>
            {% else %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                Disabled
            </span>
            {% endif %}
            <button
                hx-post="/admin/sync"
                hx-target="#sync-result"
                hx-swap="innerHTML"
                hx-indicator="#sync-spinner"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
                <svg id="sync-spinner" class="htmx-indicator animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Sync Now
            </button>
        </div>
    </div>

    <!-- Scheduler Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
        <div>
            <div class="text-xs text-gray-500 uppercase">Next Run</div>
            <div class="text-sm font-medium text-gray-900">
                {% if scheduler_status.next_run_at %}{{ scheduler_status.next_run_at }}{% else %}--{% endif %}
            </div>
        </div>
        <div>
            <div class="text-xs text-gray-500 uppercase">Last Run</div>
            <div class="text-sm font-medium text-gray-900">
                {% if scheduler_status.last_run_at %}{{ scheduler_status.last_run_at }}{% else %}Never{% endif %}
            </div>
        </div>
        <div>
            <div class="text-xs text-gray-500 uppercase">24h Success</div>
            <div class="text-sm font-medium text-green-600">{{ sync_stats.successful_24h }}/{{ sync_stats.total_24h }}</div>
        </div>
        <div>
            <div class="text-xs text-gray-500 uppercase">24h Failed</div>
            <div class="text-sm font-medium {% if sync_stats.failed_24h > 0 %}text-red-600{% else %}text-gray-900{% endif %}">{{ sync_stats.failed_24h }}</div>
        </div>
    </div>

    <div id="sync-result"></div>

    <!-- Recent Sync Logs -->
    {% if recent_sync_logs %}
    <div class="mt-4">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Recent Sync History</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Trigger</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Records</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for log in recent_sync_logs %}
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500">
                            {{ log.started_at.strftime('%m/%d %H:%M') }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <code class="text-xs bg-gray-100 px-1 rounded">{{ log.user_id[:12] }}{% if log.user_id|length > 12 %}...{% endif %}</code>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            {% if log.status == 'success' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Success</span>
                            {% elif log.status == 'partial' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Partial</span>
                            {% elif log.status == 'failed' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" title="{{ log.error_message }}">Failed</span>
                            {% elif log.status == 'started' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Running</span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">{{ log.status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500 text-xs">{{ log.trigger }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500">
                            {% if log.duration_ms %}{{ (log.duration_ms / 1000)|round(1) }}s{% else %}--{% endif %}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500 text-xs">
                            {% if log.records_synced %}
                            {{ log.records_synced|length }} types
                            {% else %}--{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Two Column Layout for Tables -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Recent Sleep Data -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Recent Sleep</h2>
        </div>
        {% if recent_sleep %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Hours</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for sleep in recent_sleep %}
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{{ sleep.date }}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            {% if sleep.sleep_score %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if sleep.sleep_score >= 70 %}bg-green-100 text-green-800{% elif sleep.sleep_score >= 50 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ sleep.sleep_score }}
                            </span>
                            {% else %}--{% endif %}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                            {% if sleep.total_sleep_seconds %}{{ (sleep.total_sleep_seconds / 3600)|round(1) }}h{% else %}--{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-6 text-center text-gray-500">No sleep data yet</div>
        {% endif %}
    </div>

    <!-- Recent Recharge Data -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Nightly Recharge</h2>
        </div>
        {% if recent_recharge %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">HRV</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ANS</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for recharge in recent_recharge %}
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{{ recharge.date }}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                            {% if recharge.hrv_avg %}{{ recharge.hrv_avg|round(0) }} ms{% else %}--{% endif %}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                            {% if recharge.ans_charge %}{{ recharge.ans_charge|round(0) }}%{% else %}--{% endif %}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            {% if recharge.nightly_recharge_status %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                {% if 'GOOD' in recharge.nightly_recharge_status or 'VERY_GOOD' in recharge.nightly_recharge_status %}bg-green-100 text-green-800
                                {% elif 'COMPROMISED' in recharge.nightly_recharge_status %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ recharge.nightly_recharge_status|replace('NIGHTLY_RECHARGE_STATUS_', '')|replace('_', ' ')|title }}
                            </span>
                            {% else %}--{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-6 text-center text-gray-500">No recharge data yet</div>
        {% endif %}
    </div>
</div>

<!-- Charts Section -->
<div class="mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Trends & Analytics</h2>
        <div class="flex items-center gap-4">
            <!-- Export Dropdown -->
            <div class="relative">
                <button id="export-btn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" onclick="document.getElementById('export-menu').classList.toggle('hidden')">
                    <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export CSV
                </button>
                <div id="export-menu" class="hidden absolute right-0 mt-1 w-48 bg-white rounded-md shadow-lg border z-10">
                    <a href="/admin/export/sleep.csv?days=30" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sleep Data</a>
                    <a href="/admin/export/activity.csv?days=30" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Activity Data</a>
                    <a href="/admin/export/recharge.csv?days=30" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Recharge/HRV Data</a>
                    <a href="/admin/export/cardio-load.csv?days=30" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Cardio Load Data</a>
                </div>
            </div>
            <select id="chart-days" class="text-sm border-gray-300 rounded-md shadow-sm" onchange="refreshCharts()">
                <option value="7">Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30" selected>Last 30 days</option>
            </select>
        </div>
    </div>

    <!-- Chart Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Sleep Score Chart -->
        <div class="bg-white shadow rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-700 mb-3">Sleep Score & Duration</h3>
            <div class="h-64">
                <canvas id="sleepChart"></canvas>
            </div>
        </div>

        <!-- Activity Chart -->
        <div class="bg-white shadow rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-700 mb-3">Daily Steps</h3>
            <div class="h-64">
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <!-- Heart Rate Chart -->
        <div class="bg-white shadow rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-700 mb-3">Heart Rate (Min/Avg/Max)</h3>
            <div class="h-64">
                <canvas id="hrChart"></canvas>
            </div>
        </div>

        <!-- HRV Chart -->
        <div class="bg-white shadow rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-700 mb-3">HRV & Recovery</h3>
            <div class="h-64">
                <canvas id="hrvChart"></canvas>
            </div>
        </div>

        <!-- Cardio Load Chart -->
        <div class="bg-white shadow rounded-lg p-4 lg:col-span-2">
            <h3 class="text-sm font-medium text-gray-700 mb-3">Training Load (Strain vs Tolerance)</h3>
            <div class="h-64">
                <canvas id="cardioChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Cardio Load Details -->
{% if latest_cardio %}
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Training Load ({{ latest_cardio.date }})</h2>
    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
        <div>
            <div class="text-gray-500 text-xs uppercase">Strain</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_cardio.strain|round(0) if latest_cardio.strain else '--' }}</div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">Tolerance</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_cardio.tolerance|round(0) if latest_cardio.tolerance and latest_cardio.tolerance > 0 else '--' }}</div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">Load</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_cardio.cardio_load|round(0) if latest_cardio.cardio_load and latest_cardio.cardio_load > 0 else '--' }}</div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">Ratio</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_cardio.cardio_load_ratio|round(2) if latest_cardio.cardio_load_ratio and latest_cardio.cardio_load_ratio > 0 else '--' }}</div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">Status</div>
            <div class="text-sm font-medium text-gray-900">
                {% if latest_cardio.cardio_load_status %}
                {{ latest_cardio.cardio_load_status|replace('LOAD_STATUS_', '')|replace('_', ' ')|title }}
                {% else %}--{% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Continuous HR Details -->
{% if latest_hr %}
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Heart Rate ({{ latest_hr.date }})</h2>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div>
            <div class="text-gray-500 text-xs uppercase">Min</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_hr.hr_min if latest_hr.hr_min else '--' }} <span class="text-sm font-normal text-gray-500">bpm</span></div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">Avg</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_hr.hr_avg if latest_hr.hr_avg else '--' }} <span class="text-sm font-normal text-gray-500">bpm</span></div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">Max</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_hr.hr_max if latest_hr.hr_max else '--' }} <span class="text-sm font-normal text-gray-500">bpm</span></div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">Samples</div>
            <div class="text-xl font-bold text-gray-900">{{ latest_hr.sample_count }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Biosensing Data (SpO2, Temperature) -->
{% if latest_spo2 or latest_skin_temp %}
<div class="bg-gradient-to-r from-purple-50 to-indigo-50 shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
        <span class="inline-flex items-center">
            <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            Biosensing
        </span>
    </h2>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        {% if latest_spo2 %}
        <div>
            <div class="text-gray-500 text-xs uppercase">SpO2 ({{ latest_spo2.test_time.strftime('%m/%d') }})</div>
            <div class="text-xl font-bold text-purple-700">
                {{ latest_spo2.spo2_avg|round(1) if latest_spo2.spo2_avg else '--' }}<span class="text-sm font-normal ml-1">%</span>
            </div>
            {% if latest_spo2.spo2_min %}
            <div class="text-xs text-gray-500">Min: {{ latest_spo2.spo2_min }}%</div>
            {% endif %}
        </div>
        {% endif %}
        {% if latest_skin_temp %}
        <div>
            <div class="text-gray-500 text-xs uppercase">Skin Temp ({{ latest_skin_temp.sleep_date }})</div>
            <div class="text-xl font-bold text-purple-700">
                {{ latest_skin_temp.temperature_celsius|round(1) }}<span class="text-sm font-normal ml-1">°C</span>
            </div>
            <div class="text-xs {% if latest_skin_temp.is_elevated %}text-red-600{% else %}text-gray-500{% endif %}">
                {% if latest_skin_temp.deviation_from_baseline > 0 %}+{% endif %}{{ latest_skin_temp.deviation_from_baseline|round(2) }}° from baseline
            </div>
        </div>
        {% endif %}
        <div>
            <div class="text-gray-500 text-xs uppercase">SpO2 Records</div>
            <div class="text-xl font-bold text-gray-900">{{ spo2_count }}</div>
        </div>
        <div>
            <div class="text-gray-500 text-xs uppercase">ECG Records</div>
            <div class="text-xl font-bold text-gray-900">{{ ecg_count }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Chart.js Initialization -->
<script>
// Chart instances (for cleanup on refresh)
let sleepChart, activityChart, hrChart, hrvChart, cardioChart;

// Close export menu when clicking outside
document.addEventListener('click', function(e) {
    const menu = document.getElementById('export-menu');
    const btn = document.getElementById('export-btn');
    if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.add('hidden');
    }
});

// Tooltip descriptions for each chart type
const chartDescriptions = {
    sleep: {
        title: 'Sleep Quality',
        sleep_score: 'Overall sleep quality (0-100). 70+ is good, 85+ is excellent.',
        total_hours: 'Total time asleep. Most adults need 7-9 hours.'
    },
    activity: {
        title: 'Daily Activity',
        steps: 'Total steps. 10,000 steps is a common daily goal.'
    },
    hr: {
        title: 'Heart Rate Trends',
        hr_max: 'Highest HR during the day. Elevations may indicate stress or exercise.',
        hr_avg: 'Average resting HR. Lower is generally healthier (60-100 normal).',
        hr_min: 'Lowest HR, usually during sleep. Athletes often have lower resting HR.'
    },
    hrv: {
        title: 'Recovery Metrics',
        hrv_avg: 'Heart Rate Variability in ms. Higher = better recovery. Track your baseline.',
        ans_charge: 'ANS Charge (%). How well your autonomic nervous system recovered overnight.'
    },
    cardio: {
        title: 'Training Load',
        strain: 'Recent training stress. High strain needs recovery time.',
        tolerance: 'Your fitness capacity. Built through consistent training.',
        load_ratio: 'Strain/Tolerance ratio. 0.8-1.2 is balanced, <0.8 detraining, >1.5 overreaching.'
    }
};

// Common chart options with enhanced tooltips
const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
        intersect: false,
        mode: 'index'
    },
    plugins: {
        legend: {
            position: 'bottom',
            labels: { boxWidth: 12, padding: 15 }
        },
        tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.85)',
            titleColor: '#fff',
            bodyColor: '#e5e7eb',
            padding: 12,
            cornerRadius: 8,
            displayColors: true,
            boxPadding: 4
        }
    },
    scales: {
        x: {
            grid: { display: false },
            ticks: { maxRotation: 45, minRotation: 0 }
        },
        y: {
            beginAtZero: true,
            grid: { color: '#f3f4f6' }
        }
    }
};

// Format date labels for display
function formatDateLabel(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Create custom tooltip callback
function createTooltipCallback(descriptions) {
    return {
        callbacks: {
            afterBody: function(context) {
                const datasetLabel = context[0]?.dataset?.label?.toLowerCase().replace(/ /g, '_');
                const key = Object.keys(descriptions).find(k => datasetLabel?.includes(k.replace('_', ' ')) || datasetLabel?.includes(k));
                if (key && descriptions[key]) {
                    return '\n' + descriptions[key];
                }
                return '';
            }
        }
    };
}

// Fetch and render all charts
async function refreshCharts() {
    const days = document.getElementById('chart-days').value;

    // Destroy existing charts
    [sleepChart, activityChart, hrChart, hrvChart, cardioChart].forEach(chart => {
        if (chart) chart.destroy();
    });

    // Fetch all data in parallel
    const [sleepData, activityData, hrData, hrvData, cardioData] = await Promise.all([
        fetch(`/admin/api/charts/sleep?days=${days}`).then(r => r.json()),
        fetch(`/admin/api/charts/activity?days=${days}`).then(r => r.json()),
        fetch(`/admin/api/charts/heart-rate?days=${days}`).then(r => r.json()),
        fetch(`/admin/api/charts/hrv?days=${days}`).then(r => r.json()),
        fetch(`/admin/api/charts/cardio-load?days=${days}`).then(r => r.json())
    ]);

    // Sleep Chart (Sleep Score + Duration)
    const sleepLabels = sleepData.labels.map(formatDateLabel);
    sleepChart = new Chart(document.getElementById('sleepChart'), {
        type: 'line',
        data: {
            labels: sleepLabels,
            datasets: [
                {
                    label: 'Sleep Score',
                    data: sleepData.datasets.sleep_score,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: 'Hours',
                    data: sleepData.datasets.total_hours,
                    borderColor: '#8b5cf6',
                    borderDash: [5, 5],
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    ...commonOptions.plugins.tooltip,
                    callbacks: {
                        afterTitle: () => 'Sleep Quality Metrics',
                        afterLabel: (ctx) => {
                            if (ctx.dataset.label === 'Sleep Score') {
                                const v = ctx.raw;
                                if (v >= 85) return '  Excellent sleep!';
                                if (v >= 70) return '  Good sleep quality';
                                if (v >= 50) return '  Fair - room for improvement';
                                return '  Poor - check sleep habits';
                            }
                            if (ctx.dataset.label === 'Hours') {
                                const v = ctx.raw;
                                if (v >= 7 && v <= 9) return '  Optimal range';
                                if (v < 7) return '  Consider more sleep';
                                return '  May be oversleeping';
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, max: 100, title: { display: true, text: 'Score' } },
                y1: { position: 'right', beginAtZero: true, max: 12, title: { display: true, text: 'Hours' }, grid: { display: false } }
            }
        }
    });

    // Activity Chart (Steps)
    const activityLabels = activityData.labels.map(formatDateLabel);
    activityChart = new Chart(document.getElementById('activityChart'), {
        type: 'bar',
        data: {
            labels: activityLabels,
            datasets: [{
                label: 'Steps',
                data: activityData.datasets.steps,
                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                borderRadius: 4
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    ...commonOptions.plugins.tooltip,
                    callbacks: {
                        afterTitle: () => 'Daily Activity',
                        afterLabel: (ctx) => {
                            const v = ctx.raw;
                            if (v >= 10000) return '  Great! Hit the 10k goal';
                            if (v >= 7500) return '  Good activity level';
                            if (v >= 5000) return '  Moderate - try to move more';
                            return '  Low - consider a walk';
                        }
                    }
                }
            },
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'Steps' } }
            }
        }
    });

    // Heart Rate Chart (Min/Avg/Max as area bands)
    const hrLabels = hrData.labels.map(formatDateLabel);
    hrChart = new Chart(document.getElementById('hrChart'), {
        type: 'line',
        data: {
            labels: hrLabels,
            datasets: [
                {
                    label: 'Max HR',
                    data: hrData.datasets.hr_max,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Avg HR',
                    data: hrData.datasets.hr_avg,
                    borderColor: '#f97316',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Min HR',
                    data: hrData.datasets.hr_min,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    ...commonOptions.plugins.tooltip,
                    callbacks: {
                        afterTitle: () => 'Heart Rate Analysis',
                        afterLabel: (ctx) => {
                            const label = ctx.dataset.label;
                            const v = ctx.raw;
                            if (label === 'Min HR') {
                                if (v < 50) return '  Very low - athletic or bradycardia';
                                if (v < 60) return '  Excellent resting HR';
                                if (v < 70) return '  Good resting HR';
                                return '  Consider cardio training';
                            }
                            if (label === 'Max HR') {
                                return '  Peak during activity/stress';
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'BPM' } }
            }
        }
    });

    // HRV Chart
    const hrvLabels = hrvData.labels.map(formatDateLabel);
    hrvChart = new Chart(document.getElementById('hrvChart'), {
        type: 'line',
        data: {
            labels: hrvLabels,
            datasets: [
                {
                    label: 'HRV (ms)',
                    data: hrvData.datasets.hrv_avg,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: 'ANS Charge (%)',
                    data: hrvData.datasets.ans_charge,
                    borderColor: '#06b6d4',
                    borderDash: [5, 5],
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    ...commonOptions.plugins.tooltip,
                    callbacks: {
                        afterTitle: () => 'Recovery Metrics',
                        afterLabel: (ctx) => {
                            const label = ctx.dataset.label;
                            const v = ctx.raw;
                            if (label === 'HRV (ms)') {
                                return '  Higher = better recovery. Track your personal baseline.';
                            }
                            if (label === 'ANS Charge (%)') {
                                if (v >= 70) return '  Excellent recovery';
                                if (v >= 50) return '  Good recovery';
                                if (v >= 30) return '  Moderate - take it easy';
                                return '  Poor - prioritize rest';
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'HRV (ms)' } },
                y1: { position: 'right', beginAtZero: true, max: 100, title: { display: true, text: 'ANS %' }, grid: { display: false } }
            }
        }
    });

    // Cardio Load Chart (Strain vs Tolerance)
    const cardioLabels = cardioData.labels.map(formatDateLabel);
    cardioChart = new Chart(document.getElementById('cardioChart'), {
        type: 'line',
        data: {
            labels: cardioLabels,
            datasets: [
                {
                    label: 'Strain',
                    data: cardioData.datasets.strain,
                    borderColor: '#f97316',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Tolerance',
                    data: cardioData.datasets.tolerance,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Load Ratio',
                    data: cardioData.datasets.load_ratio,
                    borderColor: '#6366f1',
                    borderDash: [5, 5],
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    ...commonOptions.plugins.tooltip,
                    callbacks: {
                        afterTitle: () => 'Training Load Balance',
                        afterLabel: (ctx) => {
                            const label = ctx.dataset.label;
                            const v = ctx.raw;
                            if (label === 'Strain') {
                                return '  Recent training stress (7-day avg)';
                            }
                            if (label === 'Tolerance') {
                                return '  Your fitness capacity (28-day avg)';
                            }
                            if (label === 'Load Ratio') {
                                if (v >= 1.5) return '  High risk of overtraining!';
                                if (v >= 1.2) return '  Productive overreaching';
                                if (v >= 0.8) return '  Balanced training';
                                if (v >= 0.5) return '  Maintenance mode';
                                return '  Detraining - increase volume';
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'Load' } },
                y1: { position: 'right', beginAtZero: true, max: 3, title: { display: true, text: 'Ratio' }, grid: { display: false } }
            }
        }
    });
}

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', refreshCharts);

// Refresh charts after sync completes
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'sync-result') {
        refreshCharts();
    }
});
</script>
{% endblock %}
