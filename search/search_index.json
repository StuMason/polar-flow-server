{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"polar-flow-server","text":"<p>Self-hosted health analytics server for Polar devices.</p> <p></p>"},{"location":"#what-this-does","title":"What This Does","text":"<p>Polar devices collect health data: sleep, HRV, activity, exercises. The Polar API provides access to this data, but only for the last 28-30 days. This server:</p> <ol> <li>Syncs data from Polar API automatically</li> <li>Stores everything in a local database (DuckDB or PostgreSQL)</li> <li>Runs analytics (HRV baselines, recovery scores, sleep debt)</li> <li>Exposes REST API for dashboards and integrations</li> <li>Provides MCP server for Claude Desktop integration</li> </ol>"},{"location":"#features","title":"Features","text":"<p>Data Storage: - Sleep data with HRV and sleep stages - Nightly Recharge (ANS charge, recovery metrics) - Daily activity (steps, calories, zones) - Exercises/workouts with detailed metrics</p> <p>Analytics: - Personal baselines with IQR-based anomaly detection - Rolling averages (7-day, 30-day, 90-day) - Automatic anomaly alerts (warning/critical severity) - Analytics readiness tracking (feature unlock by data availability) - Training load ratio monitoring - Sleep-HRV correlation analysis (Spearman) - Overtraining risk scoring (multi-metric composite) - Trend detection (7-day vs 30-day baseline) - Unified insights API with natural language observations</p> <p>Deployment: - Self-hosted mode: Single user, DuckDB, Docker - SaaS mode: Multi-user, PostgreSQL, Laravel integration</p>"},{"location":"#architecture","title":"Architecture","text":"<pre><code>flowchart LR\n    A[Polar API] --&gt; B[polar-flow SDK]\n    B --&gt; C[Sync Service]\n    C --&gt; D[(Database)]\n    D --&gt; E[Analytics Engine]\n    E --&gt; F[REST API]\n    F --&gt; G[Dashboard/App]</code></pre> <p>Python data analytics engine: - Litestar (async web framework) - SQLAlchemy 2.0 (async ORM) - DuckDB (self-hosted) or PostgreSQL (SaaS) - Polars (data processing) - Strict type checking with mypy</p>"},{"location":"#multi-tenancy","title":"Multi-Tenancy","text":"<p>Built for multi-user from day 1: - Every database table includes <code>user_id</code> column - All API endpoints scoped by <code>user_id</code> - Single user for self-hosted, many users for SaaS - Same codebase for both deployment modes</p>"},{"location":"#quick-start","title":"Quick Start","text":""},{"location":"#self-hosted-docker","title":"Self-Hosted (Docker)","text":"<pre><code>docker run -d \\\n  -p 8000:8000 \\\n  -v ~/.polar-flow:/root/.polar-flow \\\n  -v polar-data:/data \\\n  --name polar-flow-server \\\n  stumason/polar-flow-server\n</code></pre>"},{"location":"#api-usage","title":"API Usage","text":"<pre><code># Get sleep data\ncurl http://localhost:8000/api/v1/users/12345/sleep?days=30\n\n# Get personal baselines\ncurl http://localhost:8000/api/v1/users/12345/baselines\n\n# Check if HRV is anomalous\ncurl http://localhost:8000/api/v1/users/12345/baselines/check/hrv_rmssd/25.5\n\n# Get detected patterns (correlations, trends, risk scores)\ncurl http://localhost:8000/api/v1/users/12345/patterns\n\n# Trigger pattern detection\ncurl -X POST http://localhost:8000/api/v1/users/12345/patterns/detect\n\n# Scan all metrics for anomalies\ncurl http://localhost:8000/api/v1/users/12345/anomalies\n\n# Get unified insights (baselines + patterns + observations)\ncurl http://localhost:8000/api/v1/users/12345/insights\n\n# Check analytics feature availability\ncurl http://localhost:8000/api/v1/users/12345/analytics/status\n\n# Trigger sync\ncurl -X POST \\\n  -H \"X-Polar-Token: your_token\" \\\n  http://localhost:8000/api/v1/users/12345/sync/trigger\n</code></pre>"},{"location":"#links","title":"Links","text":"<ul> <li>Quick Start Guide</li> <li>Integration Guide - Laravel/SaaS integration</li> <li>Architecture</li> <li>API Reference</li> <li>GitHub Repository</li> <li>polar-flow SDK</li> <li>LLM-Friendly Docs - Aggregated text for AI tools</li> </ul>"},{"location":"architecture/","title":"Architecture","text":"<p>Technical architecture of polar-flow-server.</p>"},{"location":"architecture/#system-overview","title":"System Overview","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Polar API     \u2502\u2500\u2500\u2500\u2500\u25b6\u2502  Sync Service   \u2502\u2500\u2500\u2500\u2500\u25b6\u2502    Database     \u2502\n\u2502  (AccessLink)   \u2502     \u2502  (polar-flow)   \u2502     \u2502 (PostgreSQL/    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502    DuckDB)      \u2502\n                                                 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                          \u2502\n                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510               \u2502\n                        \u2502   REST API      \u2502\u25c0\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502   (Litestar)    \u2502\n                        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u2502                  \u2502                  \u2502\n              \u25bc                  \u25bc                  \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502Dashboard \u2502      \u2502  Mobile  \u2502      \u2502   MCP    \u2502\n        \u2502  (Web)   \u2502      \u2502   App    \u2502      \u2502 (Claude) \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#components","title":"Components","text":""},{"location":"architecture/#sync-service","title":"Sync Service","text":"<p>Fetches data from Polar AccessLink API using the polar-flow SDK.</p> <p>Responsibilities: - Authenticate with Polar API using OAuth2 tokens - Fetch all data types (sleep, activity, exercises, etc.) - Transform SDK models to database schemas - Upsert records (insert or update on conflict)</p> <p>Data flow: 1. SDK fetches JSON from Polar API 2. Pydantic models validate and parse response 3. Transformers convert SDK models to database dicts 4. SQLAlchemy upserts records by unique key</p>"},{"location":"architecture/#transformers","title":"Transformers","text":"<p>Bridge between SDK models and database schemas. Located in <code>src/polar_flow_server/transformers/</code>.</p> <p>Each transformer: - Accepts SDK model + user_id - Returns dict ready for database insertion - Handles field name mapping (SDK \u2192 DB) - Performs type conversions (timestamps, JSON serialization)</p> <p>Example: <pre><code>from polar_flow_server.transformers import SleepTransformer\n\n# SDK model from polar-flow\nsdk_sleep = await client.sleep.list()\n\n# Transform to database dict\ndb_dict = SleepTransformer.transform(sdk_sleep[0], user_id=\"12345\")\n</code></pre></p>"},{"location":"architecture/#database-models","title":"Database Models","text":"<p>SQLAlchemy 2.0 async models in <code>src/polar_flow_server/models/</code>.</p> <p>Core tables: - <code>sleep</code> - Nightly sleep data with stages, HRV, vitals - <code>nightly_recharge</code> - ANS charge, recovery status - <code>activity</code> - Daily steps, calories, active time - <code>exercise</code> - Workouts with duration, distance, HR</p> <p>Analytics tables: - <code>cardio_load</code> - Training strain and tolerance - <code>sleepwise_alertness</code> - Hourly alertness predictions - <code>sleepwise_bedtime</code> - Optimal sleep timing - <code>continuous_hr</code> - Daily heart rate summaries - <code>activity_samples</code> - Minute-by-minute activity</p> <p>Biosensing tables: - <code>spo2</code> - Blood oxygen measurements - <code>ecg</code> - ECG recordings with waveforms - <code>body_temperature</code> - Continuous body temp - <code>skin_temperature</code> - Nightly skin temp</p> <p>All tables include: - <code>id</code> (auto-increment primary key) - <code>user_id</code> (string, for multi-tenancy) - <code>created_at</code>, <code>updated_at</code> (timestamps)</p>"},{"location":"architecture/#rest-api","title":"REST API","text":"<p>Litestar async web framework serving JSON endpoints.</p> <p>Structure: - <code>/api/v1/users/{user_id}/...</code> - User-scoped data endpoints - <code>/api/v1/users/{user_id}/sync/trigger</code> - Manual sync trigger - <code>/health</code> - Health check - <code>/admin/...</code> - Admin dashboard (if enabled)</p> <p>Database sessions: - Injected via Litestar dependency injection - Async SQLAlchemy sessions - Connection pooling via asyncpg (PostgreSQL) or aiosqlite (DuckDB)</p>"},{"location":"architecture/#multi-tenancy","title":"Multi-Tenancy","text":"<p>Every database query is scoped by <code>user_id</code>:</p> <pre><code>stmt = (\n    select(Sleep)\n    .where(Sleep.user_id == user_id)\n    .where(Sleep.date &gt;= since_date)\n)\n</code></pre> <p>Self-hosted mode: - Single user - <code>user_id</code> = Polar API user ID - DuckDB for simple deployment</p> <p>SaaS mode: - Multiple users - <code>user_id</code> = Your application's user ID (e.g., Laravel UUID) - PostgreSQL for production</p>"},{"location":"architecture/#configuration","title":"Configuration","text":"<p>Environment variables via Pydantic Settings:</p> Variable Description Default <code>DATABASE_URL</code> Database connection string <code>sqlite+aiosqlite:///./data.db</code> <code>SYNC_DAYS_LOOKBACK</code> Days to sync by default <code>28</code> <code>POLAR_TOKEN_PATH</code> Path to token file <code>~/.polar-flow/token</code> <code>LOG_LEVEL</code> Logging level <code>INFO</code> <code>ADMIN_ENABLED</code> Enable admin dashboard <code>false</code>"},{"location":"architecture/#tech-stack","title":"Tech Stack","text":"<ul> <li>Framework: Litestar (async, high-performance)</li> <li>ORM: SQLAlchemy 2.0 (async)</li> <li>Database: PostgreSQL (prod) / DuckDB (self-hosted)</li> <li>SDK: polar-flow (Polar API client)</li> <li>Validation: Pydantic 2</li> <li>Logging: structlog (structured JSON logs)</li> <li>Type checking: mypy strict mode</li> </ul>"},{"location":"integration/","title":"Integration Guide","text":"<p>How to consume polar-flow-server from your application (Laravel, Next.js, mobile apps, etc.).</p>"},{"location":"integration/#architecture-overview","title":"Architecture Overview","text":"<pre><code>flowchart LR\n    subgraph Frontend[\"Your Frontend (Laravel/etc)\"]\n        A[User Auth]\n        B[Dashboard]\n        C[Mobile App]\n    end\n\n    subgraph Server[\"polar-flow-server\"]\n        D[REST API]\n        E[Background Sync]\n        F[Analytics Engine]\n    end\n\n    subgraph Polar[\"Polar API\"]\n        G[Data Source]\n    end\n\n    Frontend --&gt;|API Key Auth| Server\n    Server --&gt;|OAuth Token| Polar\n    E --&gt;|Hourly| Polar\n    F --&gt;|Baselines &amp; Patterns| D</code></pre> <p>Your app handles: - User authentication (login, sessions, JWT) - User management - Rendering dashboards/UI - User-facing notifications</p> <p>polar-flow-server handles: - Polar API integration &amp; data sync - Data storage (PostgreSQL) - Analytics calculations - Baseline &amp; pattern detection</p>"},{"location":"integration/#api-authentication","title":"API Authentication","text":"<p>All data endpoints require an API key via the <code>X-API-Key</code> header.</p> <pre><code># Example request with API key\ncurl -H \"X-API-Key: pfk_your_api_key_here\" \\\n  http://your-server:8000/api/v1/users/12345/sleep?days=7\n</code></pre>"},{"location":"integration/#getting-an-api-key","title":"Getting an API Key","text":"<p>API keys are created in the admin dashboard when users connect their Polar account via OAuth. For self-hosted deployments, you can also use the CLI:</p> <pre><code># Create a new API key\nuv run polar-flow-server api-key create --name \"Laravel Production\"\n\n# Output: API Key: pfk_xxxxxxxxxxxxxxxxxxxx (save this - only shown once!)\n</code></pre>"},{"location":"integration/#quick-start-laravel-integration","title":"Quick Start: Laravel Integration","text":""},{"location":"integration/#1-store-configuration","title":"1. Store Configuration","text":"<pre><code>// config/services.php\nreturn [\n    'polar_flow' =&gt; [\n        'url' =&gt; env('POLAR_FLOW_URL', 'http://localhost:8000'),\n        'api_key' =&gt; env('POLAR_FLOW_API_KEY'),\n    ],\n];\n</code></pre> <pre><code># .env\nPOLAR_FLOW_URL=https://polar-flow.example.com\nPOLAR_FLOW_API_KEY=pfk_your_api_key_here\n</code></pre>"},{"location":"integration/#2-create-http-client-service","title":"2. Create HTTP Client Service","text":"<pre><code>&lt;?php\n// app/Services/PolarFlowService.php\n\nnamespace App\\Services;\n\nuse Illuminate\\Support\\Facades\\Http;\nuse Illuminate\\Http\\Client\\PendingRequest;\n\nclass PolarFlowService\n{\n    protected PendingRequest $client;\n\n    public function __construct()\n    {\n        $this-&gt;client = Http::baseUrl(config('services.polar_flow.url') . '/api/v1')\n            -&gt;withHeaders([\n                'X-API-Key' =&gt; config('services.polar_flow.api_key'),\n            ])\n            -&gt;timeout(30);\n    }\n\n    /**\n     * Get sleep data for a user.\n     */\n    public function getSleep(string $userId, int $days = 7): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/sleep\", ['days' =&gt; $days])\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Get unified insights for a user.\n     * This is the main endpoint for dashboards.\n     */\n    public function getInsights(string $userId): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/insights\")\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Get activity data.\n     */\n    public function getActivity(string $userId, int $days = 30): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/activity\", ['days' =&gt; $days])\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Get exercises/workouts.\n     */\n    public function getExercises(string $userId, int $days = 30): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/exercises\", ['days' =&gt; $days])\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Get HRV/recharge data.\n     */\n    public function getRecharge(string $userId, int $days = 30): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/recharge\", ['days' =&gt; $days])\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Get cardio load data.\n     */\n    public function getCardioLoad(string $userId, int $days = 30): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/cardio-load\", ['days' =&gt; $days])\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Get personal baselines.\n     */\n    public function getBaselines(string $userId): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/baselines\")\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Get detected patterns.\n     */\n    public function getPatterns(string $userId): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/patterns\")\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Scan for anomalies.\n     */\n    public function getAnomalies(string $userId): array\n    {\n        return $this-&gt;client\n            -&gt;get(\"/users/{$userId}/anomalies\")\n            -&gt;throw()\n            -&gt;json();\n    }\n\n    /**\n     * Trigger a manual sync for a user.\n     * Requires the user's Polar access token.\n     */\n    public function triggerSync(string $userId, string $polarToken, int $days = 30): array\n    {\n        return $this-&gt;client\n            -&gt;withHeaders(['X-Polar-Token' =&gt; $polarToken])\n            -&gt;post(\"/users/{$userId}/sync/trigger\", ['days' =&gt; $days])\n            -&gt;throw()\n            -&gt;json();\n    }\n}\n</code></pre>"},{"location":"integration/#3-register-the-service","title":"3. Register the Service","text":"<pre><code>// app/Providers/AppServiceProvider.php\n\npublic function register(): void\n{\n    $this-&gt;app-&gt;singleton(PolarFlowService::class);\n}\n</code></pre>"},{"location":"integration/#4-use-in-controllers","title":"4. Use in Controllers","text":"<pre><code>&lt;?php\n// app/Http/Controllers/DashboardController.php\n\nnamespace App\\Http\\Controllers;\n\nuse App\\Services\\PolarFlowService;\nuse Illuminate\\Http\\Request;\n\nclass DashboardController extends Controller\n{\n    public function __construct(\n        protected PolarFlowService $polarFlow\n    ) {}\n\n    public function index(Request $request)\n    {\n        $user = $request-&gt;user();\n\n        // Fetch unified insights (recommended for dashboards)\n        $insights = $this-&gt;polarFlow-&gt;getInsights($user-&gt;polar_user_id);\n\n        return view('dashboard', [\n            'insights' =&gt; $insights,\n            'currentMetrics' =&gt; $insights['current_metrics'],\n            'baselines' =&gt; $insights['baselines'],\n            'patterns' =&gt; $insights['patterns'],\n            'observations' =&gt; $insights['observations'],\n            'suggestions' =&gt; $insights['suggestions'],\n        ]);\n    }\n\n    public function sleep(Request $request)\n    {\n        $user = $request-&gt;user();\n        $days = $request-&gt;get('days', 30);\n\n        $sleep = $this-&gt;polarFlow-&gt;getSleep($user-&gt;polar_user_id, $days);\n\n        return view('sleep', ['sleep' =&gt; $sleep]);\n    }\n}\n</code></pre>"},{"location":"integration/#key-endpoints-for-dashboards","title":"Key Endpoints for Dashboards","text":""},{"location":"integration/#1-usersuser_idinsights-recommended","title":"1. <code>/users/{user_id}/insights</code> (Recommended)","text":"<p>Use this endpoint for dashboards. It aggregates everything into a single response:</p> <ul> <li>Current metric values</li> <li>Personal baseline comparisons</li> <li>Detected patterns (correlations, trends, risk scores)</li> <li>Anomalies</li> <li>Natural language observations</li> <li>Actionable suggestions</li> </ul> <pre><code>$insights = $polarFlow-&gt;getInsights($userId);\n\n// Check data availability\nif ($insights['status'] === 'unavailable') {\n    // Show onboarding message\n    return \"Keep wearing your device! Insights unlock after 7 days.\";\n}\n\n// Display current metrics\n$hrv = $insights['current_metrics']['hrv'];\n$sleepScore = $insights['current_metrics']['sleep_score'];\n\n// Display suggestions\nforeach ($insights['suggestions'] as $suggestion) {\n    echo \"{$suggestion['description']} (confidence: {$suggestion['confidence']})\";\n}\n</code></pre>"},{"location":"integration/#2-usersuser_idbaselines","title":"2. <code>/users/{user_id}/baselines</code>","text":"<p>Get personal baselines for anomaly detection:</p> <pre><code>$baselines = $polarFlow-&gt;getBaselines($userId);\n\nforeach ($baselines as $baseline) {\n    echo \"{$baseline['metric_name']}: {$baseline['baseline_value']}\";\n    echo \"7-day: {$baseline['baseline_7d']}, 30-day: {$baseline['baseline_30d']}\";\n    echo \"Range: {$baseline['min']} - {$baseline['max']}\";\n}\n</code></pre>"},{"location":"integration/#3-usersuser_idpatterns","title":"3. <code>/users/{user_id}/patterns</code>","text":"<p>Get detected patterns:</p> <pre><code>$patterns = $polarFlow-&gt;getPatterns($userId);\n\nforeach ($patterns as $pattern) {\n    if ($pattern['pattern_name'] === 'overtraining_risk') {\n        $risk = $pattern['score'];\n        $severity = $pattern['significance'];\n\n        if ($severity === 'high') {\n            // Alert user about overtraining risk\n        }\n    }\n}\n</code></pre>"},{"location":"integration/#feature-availability-timeline","title":"Feature Availability Timeline","text":"<p>Features unlock progressively as users accumulate data:</p> Days Features Available 0-6 Raw data only, no analytics 7+ 7-day baselines 21+ Pattern detection, anomaly detection 30+ Full 30-day baselines 60+ ML predictions (future) <p>Check availability in the insights response:</p> <pre><code>$insights = $polarFlow-&gt;getInsights($userId);\n\nif ($insights['feature_availability']['patterns']['available']) {\n    // Show patterns section\n} else {\n    $message = $insights['feature_availability']['patterns']['message'];\n    // Show: \"Patterns unlock in 14 days\"\n}\n</code></pre>"},{"location":"integration/#user-mapping","title":"User Mapping","text":"<p>Your app needs to track which Polar user ID belongs to which app user.</p>"},{"location":"integration/#database-schema","title":"Database Schema","text":"<pre><code>// Laravel migration\nSchema::table('users', function (Blueprint $table) {\n    $table-&gt;string('polar_user_id')-&gt;nullable()-&gt;unique();\n    $table-&gt;timestamp('polar_connected_at')-&gt;nullable();\n});\n</code></pre>"},{"location":"integration/#oauth-flow","title":"OAuth Flow","text":"<p>When users connect their Polar account:</p> <ol> <li>User clicks \"Connect Polar\" in your app</li> <li>Redirect to polar-flow-server's OAuth endpoint</li> <li>polar-flow-server handles Polar OAuth</li> <li>Callback returns with <code>polar_user_id</code></li> <li>Store the mapping in your <code>users</code> table</li> </ol>"},{"location":"integration/#error-handling","title":"Error Handling","text":"<pre><code>use Illuminate\\Http\\Client\\RequestException;\n\ntry {\n    $insights = $polarFlow-&gt;getInsights($userId);\n} catch (RequestException $e) {\n    $status = $e-&gt;response-&gt;status();\n\n    if ($status === 401) {\n        // Invalid API key\n        Log::error('Polar Flow API key is invalid');\n    } elseif ($status === 404) {\n        // User not found\n        // Prompt user to connect Polar account\n    } elseif ($status === 429) {\n        // Rate limited\n        Log::warning('Polar Flow rate limited');\n    } else {\n        throw $e;\n    }\n}\n</code></pre>"},{"location":"integration/#caching-strategy","title":"Caching Strategy","text":"<p>Polar data doesn't change frequently. Cache responses:</p> <pre><code>use Illuminate\\Support\\Facades\\Cache;\n\npublic function getInsights(string $userId): array\n{\n    return Cache::remember(\n        \"polar_insights_{$userId}\",\n        now()-&gt;addMinutes(15),\n        fn () =&gt; $this-&gt;client\n            -&gt;get(\"/users/{$userId}/insights\")\n            -&gt;throw()\n            -&gt;json()\n    );\n}\n</code></pre> <p>Invalidate cache when user triggers manual sync:</p> <pre><code>public function triggerSync(string $userId, string $polarToken): array\n{\n    $result = $this-&gt;client\n        -&gt;withHeaders(['X-Polar-Token' =&gt; $polarToken])\n        -&gt;post(\"/users/{$userId}/sync/trigger\")\n        -&gt;throw()\n        -&gt;json();\n\n    // Clear cached data\n    Cache::forget(\"polar_insights_{$userId}\");\n    Cache::forget(\"polar_sleep_{$userId}\");\n\n    return $result;\n}\n</code></pre>"},{"location":"integration/#background-sync","title":"Background Sync","text":"<p>polar-flow-server automatically syncs data every hour (configurable). Your app doesn't need to trigger syncs unless you want immediate updates.</p>"},{"location":"integration/#auto-sync-configuration","title":"Auto-sync Configuration","text":"<p>On the server side: <pre><code>SYNC_ENABLED=true\nSYNC_INTERVAL_MINUTES=60\n</code></pre></p>"},{"location":"integration/#manual-sync-from-your-app","title":"Manual Sync from Your App","text":"<p>Only trigger manual syncs when users explicitly request it:</p> <pre><code>// In your controller\npublic function refresh(Request $request)\n{\n    $user = $request-&gt;user();\n\n    // Get user's Polar token from your storage\n    $polarToken = decrypt($user-&gt;polar_access_token);\n\n    $result = $this-&gt;polarFlow-&gt;triggerSync(\n        $user-&gt;polar_user_id,\n        $polarToken\n    );\n\n    return back()-&gt;with('success', 'Data synced! New records: ' . array_sum($result['results']));\n}\n</code></pre>"},{"location":"integration/#complete-api-reference","title":"Complete API Reference","text":"<p>See API Reference for all available endpoints.</p>"},{"location":"integration/#data-endpoints","title":"Data Endpoints","text":"<ul> <li><code>/users/{user_id}/sleep</code> - Sleep data</li> <li><code>/users/{user_id}/activity</code> - Daily activity</li> <li><code>/users/{user_id}/recharge</code> - HRV/Nightly Recharge</li> <li><code>/users/{user_id}/exercises</code> - Workouts</li> <li><code>/users/{user_id}/cardio-load</code> - Training load</li> <li><code>/users/{user_id}/heart-rate</code> - Continuous HR</li> <li><code>/users/{user_id}/sleepwise/alertness</code> - Alertness predictions</li> <li><code>/users/{user_id}/sleepwise/bedtime</code> - Optimal bedtime</li> </ul>"},{"location":"integration/#biosensing-endpoints-vantage-v3","title":"Biosensing Endpoints (Vantage V3)","text":"<ul> <li><code>/users/{user_id}/spo2</code> - Blood oxygen</li> <li><code>/users/{user_id}/ecg</code> - ECG recordings</li> <li><code>/users/{user_id}/temperature/body</code> - Body temperature</li> <li><code>/users/{user_id}/temperature/skin</code> - Skin temperature</li> </ul>"},{"location":"integration/#analytics-endpoints","title":"Analytics Endpoints","text":"<ul> <li><code>/users/{user_id}/insights</code> - Unified insights (recommended)</li> <li><code>/users/{user_id}/baselines</code> - Personal baselines</li> <li><code>/users/{user_id}/patterns</code> - Detected patterns</li> <li><code>/users/{user_id}/anomalies</code> - Anomaly scan</li> </ul>"},{"location":"integration/#sync-endpoints","title":"Sync Endpoints","text":"<ul> <li><code>POST /users/{user_id}/sync/trigger</code> - Manual sync (requires <code>X-Polar-Token</code>)</li> </ul>"},{"location":"quickstart/","title":"Quick Start","text":"<p>Get polar-flow-server running in 5 minutes.</p>"},{"location":"quickstart/#prerequisites","title":"Prerequisites","text":"<ul> <li>Polar device (watch, fitness tracker)</li> <li>Polar AccessLink API credentials from admin.polaraccesslink.com</li> <li>Docker (recommended) or Python 3.12+</li> </ul>"},{"location":"quickstart/#1-get-polar-api-credentials","title":"1. Get Polar API Credentials","text":"<ol> <li>Go to admin.polaraccesslink.com</li> <li>Create a new client</li> <li>Set redirect URI to <code>http://localhost:8888/callback</code></li> <li>Note your <code>CLIENT_ID</code> and <code>CLIENT_SECRET</code></li> </ol>"},{"location":"quickstart/#2-authenticate-with-polar","title":"2. Authenticate with Polar","text":"<pre><code>docker run -it --rm \\\n  -e CLIENT_ID=your_client_id \\\n  -e CLIENT_SECRET=your_client_secret \\\n  -v ~/.polar-flow:/root/.polar-flow \\\n  stumason/polar-flow-server \\\n  polar-flow auth\n</code></pre> <p>This opens your browser, handles OAuth, and saves the token to <code>~/.polar-flow/token</code>.</p>"},{"location":"quickstart/#3-start-the-server","title":"3. Start the Server","text":"<pre><code>docker run -d \\\n  -p 8000:8000 \\\n  -v ~/.polar-flow:/root/.polar-flow \\\n  -v polar-data:/data \\\n  --name polar-flow-server \\\n  stumason/polar-flow-server\n</code></pre> <p>The server starts and begins syncing data every hour.</p>"},{"location":"quickstart/#4-verify","title":"4. Verify","text":"<pre><code># Check health\ncurl http://localhost:8000/health\n\n# Get your Polar user ID\nexport POLAR_USER_ID=$(cat ~/.polar-flow/user_id)\n\n# Get sleep data\ncurl http://localhost:8000/api/v1/users/$POLAR_USER_ID/sleep?days=7\n</code></pre>"},{"location":"quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Architecture - System design and components</li> <li>API Reference - All available endpoints</li> <li>polar-flow SDK - Python SDK documentation</li> </ul>"},{"location":"quickstart/#from-source","title":"From Source","text":"<pre><code>git clone https://github.com/StuMason/polar-flow-server.git\ncd polar-flow-server\n\n# Install dependencies\nuv sync\n\n# Run server\nuv run polar-flow-server serve\n</code></pre> <p>Requires Python 3.12+ and uv package manager.</p>"},{"location":"adr/001-per-user-api-keys/","title":"ADR-001: Per-User API Keys for Multi-Tenant SaaS Support","text":""},{"location":"adr/001-per-user-api-keys/#status","title":"Status","text":"<p>Proposed (Revised based on security review)</p>"},{"location":"adr/001-per-user-api-keys/#context","title":"Context","text":"<p>polar-flow-server is designed to work in two modes:</p> <ol> <li>Self-hosted: Single user boots up an instance, connects their Polar account, uses dashboard or API</li> <li>SaaS backend: Laravel frontend (myloopcoach.com) manages users, polar-flow-server handles Polar data sync/storage</li> </ol> <p>The current authentication model uses a single API key for all external access. This creates a security risk for SaaS deployments: if the single key is compromised, ALL users' data is exposed.</p>"},{"location":"adr/001-per-user-api-keys/#current-architecture","title":"Current Architecture","text":"<pre><code>Laravel App                     polar-flow-server\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 All users   \u2502\u2500\u2500ONE API KEY\u2500\u2500\u25b6\u2502 All data        \u2502\n\u2502 share key   \u2502                \u2502 accessible      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nRisk: Key compromise = total data breach\n</code></pre>"},{"location":"adr/001-per-user-api-keys/#proposed-architecture","title":"Proposed Architecture","text":"<pre><code>Laravel App                     polar-flow-server\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Steve       \u2502\u2500\u2500Steve's key\u2500\u2500\u25b6\u2502 Steve's data    \u2502\n\u2502 Jane        \u2502\u2500\u2500Jane's key\u2500\u2500\u2500\u25b6\u2502 Jane's data     \u2502\n\u2502 Bob         \u2502\u2500\u2500Bob's key\u2500\u2500\u2500\u2500\u25b6\u2502 Bob's data      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nRisk: Key compromise = single user's data only\n</code></pre>"},{"location":"adr/001-per-user-api-keys/#decision","title":"Decision","text":"<p>Implement per-user API keys with the following design:</p>"},{"location":"adr/001-per-user-api-keys/#1-extend-existing-apikey-model","title":"1. Extend Existing APIKey Model","text":"<p>The codebase already has an <code>APIKey</code> model for service-level authentication. We extend it to support per-user scoping:</p> <pre><code>class APIKey(Base):\n    \"\"\"API key for authenticating service-to-service requests.\"\"\"\n\n    __tablename__ = \"api_keys\"\n\n    id: Mapped[int] = mapped_column(primary_key=True)\n    key_hash: Mapped[str] = mapped_column(String(64), unique=True, index=True)\n    key_prefix: Mapped[str] = mapped_column(String(12), index=True)  # First 8 chars for identification\n    name: Mapped[str] = mapped_column(String(100))\n    is_active: Mapped[bool] = mapped_column(default=True, index=True)\n\n    # NEW: User scoping (nullable for service-level keys)\n    user_id: Mapped[str | None] = mapped_column(\n        String(50),\n        ForeignKey(\"users.polar_user_id\"),\n        nullable=True,\n        index=True\n    )\n\n    # Rate limiting\n    rate_limit_requests: Mapped[int] = mapped_column(default=1000)  # per hour\n    rate_limit_remaining: Mapped[int] = mapped_column(default=1000)\n    rate_limit_reset_at: Mapped[datetime | None] = mapped_column(nullable=True)\n\n    created_at: Mapped[datetime] = mapped_column(server_default=func.now())\n    last_used_at: Mapped[datetime | None] = mapped_column(nullable=True)\n\n    # Relationship\n    user: Mapped[\"User | None\"] = relationship(back_populates=\"api_keys\")\n</code></pre> <p>Key behaviors: - <code>user_id = None</code>: Service-level key with full access (existing behavior) - <code>user_id = \"12345\"</code>: User-scoped key, can only access that user's data</p>"},{"location":"adr/001-per-user-api-keys/#2-api-key-format","title":"2. API Key Format","text":"<pre><code>pfk_&lt;random_40_chars&gt;\nExample: pfk_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0\n</code></pre> <ul> <li><code>pfk_</code> prefix identifies it as a polar-flow-server key</li> <li>40 random alphanumeric chars for security (240 bits of entropy)</li> <li>No user ID in the key - prevents enumeration attacks</li> <li>First 8 chars stored as <code>key_prefix</code> for admin identification</li> <li>Only the hash is stored, full key shown once on creation</li> </ul>"},{"location":"adr/001-per-user-api-keys/#3-authentication-flow","title":"3. Authentication Flow","text":"<pre><code># API request\nGET /api/v1/users/{user_id}/sleep\nHeader: X-API-Key: pfk_a1b2c3d4e5f6...\n\n# Server validates (in this order):\nasync def api_key_guard(connection: ASGIConnection, handler: BaseRouteHandler) -&gt; None:\n    api_key = connection.headers.get(\"X-API-Key\")\n    if not api_key:\n        raise NotAuthorizedException(\"Missing X-API-Key header\")\n\n    # 1. Hash and lookup key\n    key_hash = hashlib.sha256(api_key.encode()).hexdigest()\n    key_record = await get_api_key_by_hash(key_hash, session)\n\n    if not key_record or not key_record.is_active:\n        raise NotAuthorizedException(\"Invalid or inactive API key\")\n\n    # 2. Check rate limit BEFORE any data access\n    if not await check_rate_limit(key_record, session):\n        raise TooManyRequestsException(\"Rate limit exceeded\", retry_after=...)\n\n    # 3. If user-scoped key, verify access to requested user\n    path_user_id = connection.path_params.get(\"user_id\")\n    if key_record.user_id is not None:\n        if path_user_id and key_record.user_id != path_user_id:\n            raise NotAuthorizedException(\"API key not authorized for this user\")\n\n    # 4. Update last_used_at\n    key_record.last_used_at = datetime.now(UTC)\n</code></pre>"},{"location":"adr/001-per-user-api-keys/#4-secure-oauth-flow-two-step-code-exchange","title":"4. Secure OAuth Flow (Two-Step Code Exchange)","text":"<p>CRITICAL SECURITY FIX: API keys are NEVER passed in URL parameters. Instead, we use a temporary authorization code that Laravel exchanges server-to-server.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  User   \u2502          \u2502  polar-flow     \u2502          \u2502   Laravel   \u2502\n\u2502 Browser \u2502          \u2502    server       \u2502          \u2502   Backend   \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502                        \u2502                          \u2502\n     \u2502 1. User clicks         \u2502                          \u2502\n     \u2502    \"Connect Polar\"     \u2502                          \u2502\n     \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502                          \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502 2. Redirect to         \u2502                          \u2502\n     \u2502    Polar OAuth         \u2502                          \u2502\n     \u2502\u25c0\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                          \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502 3. User authorizes     \u2502                          \u2502\n     \u2502    on Polar            \u2502                          \u2502\n     \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502                          \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502 4. Polar redirects     \u2502                          \u2502\n     \u2502    with OAuth code     \u2502                          \u2502\n     \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502                          \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502                        \u2502 5. Exchange OAuth code   \u2502\n     \u2502                        \u2502    for Polar tokens      \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502                        \u2502 6. Generate temp auth    \u2502\n     \u2502                        \u2502    code (expires 5min)   \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502 7. Redirect to Laravel \u2502                          \u2502\n     \u2502    with temp code only \u2502                          \u2502\n     \u2502\u25c0\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                          \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502 8. Browser follows     \u2502                          \u2502\n     \u2502    redirect            \u2502                          \u2502\n     \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6  \u2502\n     \u2502                        \u2502                          \u2502\n     \u2502                        \u2502  9. Server-to-server     \u2502\n     \u2502                        \u2502     POST with temp code  \u2502\n     \u2502                        \u2502\u25c0\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n     \u2502                        \u2502                          \u2502\n     \u2502                        \u2502 10. Validate code,       \u2502\n     \u2502                        \u2502     generate API key,    \u2502\n     \u2502                        \u2502     return in response   \u2502\n     \u2502                        \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502\n     \u2502                        \u2502                          \u2502\n     \u2502                        \u2502                          \u2502 11. Store API key\n     \u2502                        \u2502                          \u2502     securely\n</code></pre> <p>Step-by-step:</p> <ol> <li>User initiates OAuth from Laravel app</li> <li>Laravel redirects to polar-flow-server OAuth start (with Laravel callback URL)</li> <li>polar-flow-server redirects to Polar OAuth</li> <li>User authorizes on Polar</li> <li>Polar redirects back with authorization code</li> <li>polar-flow-server exchanges code for tokens, stores user</li> <li>Generate temporary auth code (random 64 chars, expires in 5 minutes, single-use)</li> <li>Redirect to Laravel callback with ONLY:    <pre><code>https://myloopcoach.com/polar/callback?\n  code=temp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n  &amp;polar_user_id=12345678\n  &amp;status=connected\n</code></pre></li> <li>Laravel backend makes server-to-server POST request:    <pre><code>POST /api/v1/oauth/exchange\nContent-Type: application/json\n\n{\n  \"code\": \"temp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\n  \"client_id\": \"laravel_app_id\"\n}\n</code></pre></li> <li>polar-flow-server validates code, generates API key, returns:     <pre><code>{\n  \"api_key\": \"pfk_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0\",\n  \"polar_user_id\": \"12345678\",\n  \"expires_at\": null\n}\n</code></pre></li> <li>Laravel stores API key encrypted in database</li> </ol> <p>Why this is secure: - API key never appears in browser history, server logs, or referrer headers - Temporary code is single-use and expires quickly - Server-to-server exchange requires client credentials - No sensitive data in URL parameters</p>"},{"location":"adr/001-per-user-api-keys/#5-new-api-endpoints","title":"5. New API Endpoints","text":"<pre><code>POST /api/v1/oauth/exchange\n  - Exchange temporary auth code for API key\n  - Requires: valid temp code, client credentials\n  - Returns: API key, user ID\n\nPOST /api/v1/users/{user_id}/api-key/regenerate\n  - Requires current valid API key for that user\n  - Invalidates old key, returns new one\n  - Use case: key rotation, suspected compromise\n\nPOST /api/v1/users/{user_id}/api-key/revoke\n  - Requires current valid API key OR admin auth\n  - Permanently invalidates key without generating new one\n  - Use case: user disconnects, account deletion\n\nGET /api/v1/users/{user_id}/status\n  - Returns connection status, last sync, key info (masked)\n  - Requires valid API key for that user\n</code></pre>"},{"location":"adr/001-per-user-api-keys/#6-rate-limiting-phase-1-critical","title":"6. Rate Limiting (Phase 1 - Critical)","text":"<p>Rate limiting is implemented at the API key level:</p> <pre><code># Default limits\nDEFAULT_RATE_LIMIT = 1000  # requests per hour\n\nasync def check_rate_limit(key: APIKey, session: AsyncSession) -&gt; bool:\n    \"\"\"Check and update rate limit for API key.\"\"\"\n    now = datetime.now(UTC)\n\n    # Reset if window expired\n    if key.rate_limit_reset_at is None or now &gt;= key.rate_limit_reset_at:\n        key.rate_limit_remaining = key.rate_limit_requests\n        key.rate_limit_reset_at = now + timedelta(hours=1)\n\n    # Check limit\n    if key.rate_limit_remaining &lt;= 0:\n        return False\n\n    # Decrement\n    key.rate_limit_remaining -= 1\n    return True\n</code></pre> <p>Response headers: <pre><code>X-RateLimit-Limit: 1000\nX-RateLimit-Remaining: 847\nX-RateLimit-Reset: 1704067200\n</code></pre></p>"},{"location":"adr/001-per-user-api-keys/#7-admin-vs-user-keys","title":"7. Admin vs User Keys","text":"Type Scope Use Case user_id Service key Full server access Admin CLI, monitoring <code>NULL</code> User API key Single user's data Laravel API calls User's polar_user_id <p>Admins can still view all data via dashboard (session auth), but API keys are scoped.</p>"},{"location":"adr/001-per-user-api-keys/#8-self-hosted-mode","title":"8. Self-Hosted Mode","text":"<p>For self-hosted single-user deployments:</p> <ol> <li>Environment variable mode (existing):</li> <li>Set <code>API_KEY</code> env var for simple single-key auth</li> <li>This key has full access (service-level)</li> <li> <p>No database lookup required</p> </li> <li> <p>Per-user mode (new):</p> </li> <li>When user connects Polar via admin UI, per-user key is generated</li> <li>Key is displayed ONCE on the success page (user must copy it)</li> <li> <p>Stored hashed in database</p> </li> <li> <p>Both modes together:</p> </li> <li><code>API_KEY</code> env var works as a master/fallback key</li> <li>Per-user keys provide additional scoped access</li> <li>Self-hosted users typically only need the env var key</li> </ol>"},{"location":"adr/001-per-user-api-keys/#9-webhook-authentication","title":"9. Webhook Authentication","text":"<p>For Laravel-initiated sync triggers via webhooks:</p> <pre><code># Laravel can trigger sync using the user's API key\nPOST /api/v1/users/{user_id}/sync/trigger\nX-API-Key: pfk_user_key_here\n\n# Or use a service-level key for batch operations\nPOST /api/v1/sync/trigger-all\nX-API-Key: pfk_service_key_here\n</code></pre> <p>Webhook callbacks FROM polar-flow-server TO Laravel use HMAC signatures: <pre><code># polar-flow-server signs webhook payload\nsignature = hmac.new(\n    webhook_secret.encode(),\n    payload.encode(),\n    hashlib.sha256\n).hexdigest()\n\n# Header: X-Webhook-Signature: sha256=xxxxx\n</code></pre></p>"},{"location":"adr/001-per-user-api-keys/#consequences","title":"Consequences","text":""},{"location":"adr/001-per-user-api-keys/#positive","title":"Positive","text":"<ul> <li>Security: Compromised key only affects one user</li> <li>Audit: Can track which user's key made each request</li> <li>Revocation: Can revoke single user's access without affecting others</li> <li>SaaS-ready: Proper multi-tenant isolation</li> <li>Rate limiting: Prevents abuse per key</li> </ul>"},{"location":"adr/001-per-user-api-keys/#negative","title":"Negative","text":"<ul> <li>Complexity: More auth logic to maintain</li> <li>Migration: Existing integrations need to update</li> <li>Key management: Laravel needs to store keys securely</li> </ul>"},{"location":"adr/001-per-user-api-keys/#neutral","title":"Neutral","text":"<ul> <li>Storage: Additional columns in api_keys table</li> <li>Performance: One extra DB lookup per request (indexed, fast)</li> </ul>"},{"location":"adr/001-per-user-api-keys/#implementation-plan","title":"Implementation Plan","text":""},{"location":"adr/001-per-user-api-keys/#phase-1-database-model-rate-limiting","title":"Phase 1: Database, Model &amp; Rate Limiting","text":"<ul> <li>[ ] Add migration to extend APIKey model with user_id, rate limit fields</li> <li>[ ] Update APIKey model with new fields and relationships</li> <li>[ ] Add temporary auth code table for OAuth exchange</li> <li>[ ] Add API key generation utility (secure random, hashing)</li> <li>[ ] Implement rate limiting logic</li> </ul>"},{"location":"adr/001-per-user-api-keys/#phase-2-oauth-integration","title":"Phase 2: OAuth Integration","text":"<ul> <li>[ ] Create temp code generation on OAuth success</li> <li>[ ] Create <code>/api/v1/oauth/exchange</code> endpoint</li> <li>[ ] Modify OAuth callback to return only temp code</li> <li>[ ] Update admin UI to display API key on successful connection</li> </ul>"},{"location":"adr/001-per-user-api-keys/#phase-3-authentication-guard","title":"Phase 3: Authentication Guard","text":"<ul> <li>[ ] Create per-user auth guard with rate limit check</li> <li>[ ] Update data endpoints to use new guard</li> <li>[ ] Add key validation and user scoping</li> <li>[ ] Implement proper 401/403/429 responses</li> </ul>"},{"location":"adr/001-per-user-api-keys/#phase-4-key-management-endpoints","title":"Phase 4: Key Management Endpoints","text":"<ul> <li>[ ] Create key regeneration endpoint</li> <li>[ ] Create key revocation endpoint</li> <li>[ ] Create user status endpoint</li> <li>[ ] Add CLI commands for key management</li> </ul>"},{"location":"adr/001-per-user-api-keys/#phase-5-admin-dashboard","title":"Phase 5: Admin Dashboard","text":"<ul> <li>[ ] Show user's API key status in admin</li> <li>[ ] Allow admin to revoke user keys</li> <li>[ ] Add rate limit and last-used tracking display</li> <li>[ ] Add key prefix display for identification</li> </ul>"},{"location":"adr/001-per-user-api-keys/#phase-6-testing","title":"Phase 6: Testing","text":"<ul> <li>[ ] Unit tests for key generation and hashing</li> <li>[ ] Unit tests for rate limiting logic</li> <li>[ ] Integration tests for OAuth two-step flow</li> <li>[ ] Integration tests for auth guard</li> <li>[ ] Security tests for cross-user access attempts</li> <li>[ ] Load tests for rate limiting behavior</li> </ul>"},{"location":"adr/001-per-user-api-keys/#phase-7-documentation","title":"Phase 7: Documentation","text":"<ul> <li>[ ] Update API docs with new auth model</li> <li>[ ] Add Laravel integration guide with code examples</li> <li>[ ] Document key rotation best practices</li> <li>[ ] Document webhook authentication</li> </ul>"},{"location":"adr/001-per-user-api-keys/#files-to-createmodify","title":"Files to Create/Modify","text":"File Changes <code>alembic/versions/xxx_add_user_api_keys.py</code> Migration for APIKey changes <code>alembic/versions/xxx_add_temp_auth_codes.py</code> Migration for temp codes table <code>src/polar_flow_server/models/api_key.py</code> Add user_id, rate limit fields <code>src/polar_flow_server/models/temp_auth_code.py</code> New temp code model <code>src/polar_flow_server/core/api_keys.py</code> Key generation/validation/rate limiting <code>src/polar_flow_server/api/auth.py</code> Per-user auth guard <code>src/polar_flow_server/api/oauth.py</code> New OAuth exchange endpoint <code>src/polar_flow_server/api/data.py</code> Update to use new guard <code>src/polar_flow_server/admin/routes.py</code> OAuth callback changes <code>docs/api-authentication.md</code> New documentation"},{"location":"adr/001-per-user-api-keys/#resolved-questions","title":"Resolved Questions","text":"<ol> <li> <p>Key expiration: No automatic expiration. Track <code>last_used_at</code> for stale key identification. Consider soft expiration (warning after 90 days) as future enhancement.</p> </li> <li> <p>Rate limiting: Yes, implemented in Phase 1. Default 1000 requests/hour per key, configurable per key.</p> </li> <li> <p>Multiple keys per user: No, keep simple. One active key per user. Regenerate replaces existing key.</p> </li> <li> <p>Lost API key recovery: User can regenerate key via the polar-flow-server admin UI (if self-hosted) or request regeneration from Laravel admin (if SaaS).</p> </li> <li> <p>Existing deployment migration:</p> </li> <li>Self-hosted: No change needed, <code>API_KEY</code> env var continues to work</li> <li> <p>SaaS: Laravel triggers reconnection flow for each user to generate per-user keys</p> </li> <li> <p>Self-hosted unused fields: Per-user key fields exist but remain NULL until used. Minimal overhead.</p> </li> <li> <p>Performance of hash lookups: api_keys.key_hash is indexed, lookup is O(log n). For very high traffic, add Redis caching layer.</p> </li> </ol>"},{"location":"adr/001-per-user-api-keys/#security-considerations","title":"Security Considerations","text":"<ol> <li>Key storage: Only SHA-256 hash stored in database. Raw key shown once on creation.</li> <li>Timing attacks: Use constant-time comparison for hash validation.</li> <li>Brute force: Rate limiting + key length (40 chars) makes brute force infeasible.</li> <li>Key rotation: Provide regeneration endpoint; recommend periodic rotation.</li> <li>Audit logging: Log all key usage with timestamp and IP (future enhancement).</li> </ol>"},{"location":"api/overview/","title":"API Reference","text":"<p>REST API for accessing synced Polar health data.</p>"},{"location":"api/overview/#base-url","title":"Base URL","text":"<pre><code>{base_url}/api/v1\n</code></pre> <p>Replace <code>{base_url}</code> with your server address: - Local development: <code>http://localhost:8000</code> - Docker: <code>http://localhost:8000</code> or your configured port - Production: Your deployed server URL (e.g., <code>https://polar.example.com</code>)</p>"},{"location":"api/overview/#openapi-specification","title":"OpenAPI Specification","text":"<p>The full OpenAPI 3.1 specification is available at:</p> <ul> <li>JSON: <code>GET /schema/openapi.json</code></li> <li>Interactive Docs: <code>GET /schema/swagger</code> (Swagger UI)</li> <li>ReDoc: <code>GET /schema/redoc</code></li> </ul> <pre><code># Download OpenAPI spec\ncurl {base_url}/schema/openapi.json &gt; openapi.json\n</code></pre>"},{"location":"api/overview/#authentication","title":"Authentication","text":""},{"location":"api/overview/#api-key-authentication","title":"API Key Authentication","text":"<p>If an API key is configured (recommended for production), include it in the <code>X-API-Key</code> header:</p> <pre><code>curl -H \"X-API-Key: your_api_key_here\" {base_url}/api/v1/users/12345/sleep\n</code></pre> <p>API keys can be created and managed from the Admin Dashboard \u2192 API Keys section.</p>"},{"location":"api/overview/#user-id","title":"User ID","text":"<p>All data endpoints require a <code>user_id</code> in the URL path. For self-hosted deployments, this is your Polar user ID (visible in the admin dashboard). For SaaS integrations, this is your application's user identifier.</p>"},{"location":"api/overview/#sync-endpoints","title":"Sync Endpoints","text":"<p>Sync endpoints additionally require a Polar API access token via the <code>X-Polar-Token</code> header.</p>"},{"location":"api/overview/#endpoints","title":"Endpoints","text":""},{"location":"api/overview/#sleep","title":"Sleep","text":"Method Endpoint Description GET <code>/users/{user_id}/sleep</code> List sleep data GET <code>/users/{user_id}/sleep/{date}</code> Get sleep by date <p>Query Parameters: - <code>days</code> (int, default: 7) - Number of days to fetch (1-365)</p> <p>Example: <pre><code>curl {base_url}/api/v1/users/12345/sleep?days=30\n</code></pre></p> <p>Response: <pre><code>[\n  {\n    \"date\": \"2026-01-11\",\n    \"sleep_score\": 85,\n    \"total_sleep_hours\": 7.5,\n    \"deep_sleep_hours\": 1.8,\n    \"rem_sleep_hours\": 1.9,\n    \"light_sleep_hours\": 3.8,\n    \"hrv_avg\": 45.2,\n    \"heart_rate_avg\": 52\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#activity","title":"Activity","text":"Method Endpoint Description GET <code>/users/{user_id}/activity</code> List daily activity GET <code>/users/{user_id}/activity/{date}</code> Get activity by date <p>Query Parameters: - <code>days</code> (int, default: 30) - Number of days to fetch (1-365)</p> <p>Example: <pre><code>curl {base_url}/api/v1/users/12345/activity?days=7\n</code></pre></p> <p>Response: <pre><code>[\n  {\n    \"date\": \"2026-01-11\",\n    \"steps\": 8542,\n    \"calories_active\": 450,\n    \"calories_total\": 2150,\n    \"distance_km\": 6.2,\n    \"active_minutes\": 45.5,\n    \"activity_score\": 78\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#nightly-recharge-hrv","title":"Nightly Recharge (HRV)","text":"Method Endpoint Description GET <code>/users/{user_id}/recharge</code> List nightly recharge data <p>Query Parameters: - <code>days</code> (int, default: 30) - Number of days to fetch (1-365)</p> <p>Example: <pre><code>curl {base_url}/api/v1/users/12345/recharge?days=14\n</code></pre></p> <p>Response: <pre><code>[\n  {\n    \"date\": \"2026-01-11\",\n    \"hrv_avg\": 48.5,\n    \"ans_charge\": 4.2,\n    \"ans_charge_status\": \"WELL_RECOVERED\",\n    \"breathing_rate_avg\": 14.2,\n    \"heart_rate_avg\": 51\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#exercises","title":"Exercises","text":"Method Endpoint Description GET <code>/users/{user_id}/exercises</code> List exercises GET <code>/users/{user_id}/exercises/{id}</code> Get exercise detail <p>Query Parameters: - <code>days</code> (int, default: 30) - Number of days to fetch (1-365)</p> <p>Example: <pre><code>curl {base_url}/api/v1/users/12345/exercises?days=30\n</code></pre></p> <p>Response: <pre><code>[\n  {\n    \"id\": 1,\n    \"polar_exercise_id\": \"abc123\",\n    \"start_time\": \"2026-01-11 07:30:00\",\n    \"sport\": \"RUNNING\",\n    \"duration_minutes\": 45.5,\n    \"distance_km\": 8.2,\n    \"calories\": 520,\n    \"average_heart_rate\": 145,\n    \"max_heart_rate\": 172,\n    \"training_load\": 85\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#cardio-load","title":"Cardio Load","text":"Method Endpoint Description GET <code>/users/{user_id}/cardio-load</code> List cardio load data <p>Query Parameters: - <code>days</code> (int, default: 30) - Number of days to fetch (1-365)</p> <p>Response: <pre><code>[\n  {\n    \"date\": \"2026-01-11\",\n    \"strain\": 125.5,\n    \"tolerance\": 180.2,\n    \"cardio_load\": 85.3,\n    \"cardio_load_ratio\": 0.70,\n    \"cardio_load_status\": \"PRODUCTIVE\"\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#heart-rate","title":"Heart Rate","text":"Method Endpoint Description GET <code>/users/{user_id}/heart-rate</code> List daily HR summaries <p>Query Parameters: - <code>days</code> (int, default: 30) - Number of days to fetch (1-365)</p> <p>Response: <pre><code>[\n  {\n    \"date\": \"2026-01-11\",\n    \"hr_min\": 48,\n    \"hr_avg\": 62,\n    \"hr_max\": 165,\n    \"sample_count\": 1440\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#sleepwise","title":"SleepWise","text":"Method Endpoint Description GET <code>/users/{user_id}/sleepwise/alertness</code> Hourly alertness predictions GET <code>/users/{user_id}/sleepwise/bedtime</code> Optimal bedtime recommendations <p>Query Parameters: - <code>days</code> (int, default: 7) - Number of days to fetch (1-30)</p> <p>Alertness Response: <pre><code>[\n  {\n    \"period_start_time\": \"2026-01-11 08:00:00\",\n    \"period_end_time\": \"2026-01-11 09:00:00\",\n    \"grade\": 4.2,\n    \"grade_classification\": \"GOOD\"\n  }\n]\n</code></pre></p> <p>Bedtime Response: <pre><code>[\n  {\n    \"period_start_time\": \"2026-01-11 00:00:00\",\n    \"period_end_time\": \"2026-01-12 00:00:00\",\n    \"preferred_sleep_start\": \"22:30:00\",\n    \"preferred_sleep_end\": \"06:30:00\",\n    \"sleep_gate_start\": \"22:00:00\",\n    \"sleep_gate_end\": \"23:00:00\",\n    \"quality\": \"GOOD\"\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#biosensing-vantage-v3","title":"Biosensing (Vantage V3)","text":"<p>Requires compatible device with Elixir sensor platform.</p> Method Endpoint Description GET <code>/users/{user_id}/spo2</code> Blood oxygen measurements GET <code>/users/{user_id}/ecg</code> ECG recordings GET <code>/users/{user_id}/temperature/body</code> Body temperature GET <code>/users/{user_id}/temperature/skin</code> Skin temperature <p>Query Parameters: - <code>days</code> (int, default: 30) - Number of days to fetch (1-365)</p> <p>SpO2 Response: <pre><code>[\n  {\n    \"test_time\": \"2026-01-11 22:30:00\",\n    \"blood_oxygen_percent\": 98,\n    \"spo2_class\": \"NORMAL\",\n    \"avg_heart_rate\": 62,\n    \"hrv_ms\": 45.2,\n    \"altitude_meters\": 150\n  }\n]\n</code></pre></p>"},{"location":"api/overview/#sync","title":"Sync","text":"Method Endpoint Description POST <code>/users/{user_id}/sync/trigger</code> Trigger data sync <p>Headers: - <code>X-Polar-Token</code> (required) - Polar API access token</p> <p>Query Parameters: - <code>days</code> (int, optional) - Days to sync (default from config)</p> <p>Example: <pre><code>curl -X POST \\\n  -H \"X-Polar-Token: your_polar_token\" \\\n  {base_url}/api/v1/users/12345/sync/trigger?days=30\n</code></pre></p> <p>Response: <pre><code>{\n  \"status\": \"success\",\n  \"user_id\": \"12345\",\n  \"results\": {\n    \"sleep\": 28,\n    \"recharge\": 28,\n    \"activity\": 28,\n    \"exercises\": 15,\n    \"cardio_load\": 28,\n    \"sleepwise_alertness\": 168,\n    \"sleepwise_bedtime\": 7,\n    \"spo2\": 5,\n    \"ecg\": 3,\n    \"body_temperature\": 7,\n    \"skin_temperature\": 7\n  }\n}\n</code></pre></p>"},{"location":"api/overview/#export","title":"Export","text":"Method Endpoint Description GET <code>/users/{user_id}/export/summary</code> Export summary manifest GET <code>/users/{user_id}/export/sleep.csv</code> Export sleep data as CSV GET <code>/users/{user_id}/export/activity.csv</code> Export activity data as CSV GET <code>/users/{user_id}/export/recharge.csv</code> Export recharge/HRV data as CSV GET <code>/users/{user_id}/export/cardio-load.csv</code> Export cardio load data as CSV <p>Query Parameters: - <code>days</code> (int, default: 30) - Number of days to include (1-365)</p>"},{"location":"api/overview/#export-summary","title":"Export Summary","text":"<p>Response: <pre><code>{\n  \"user_id\": \"12345\",\n  \"days\": 30,\n  \"from_date\": \"2025-12-12\",\n  \"to_date\": \"2026-01-11\",\n  \"record_counts\": {\n    \"sleep\": 30,\n    \"activity\": 30,\n    \"recharge\": 30,\n    \"cardio_load\": 28,\n    \"heart_rate\": 30,\n    \"exercises\": 12\n  },\n  \"total_records\": 160\n}\n</code></pre></p>"},{"location":"api/overview/#csv-exports","title":"CSV Exports","text":"<p>Download data as CSV files for use in spreadsheets, data analysis tools, or external systems.</p> <p>Example: <pre><code>curl -H \"X-API-Key: pfk_...\" \\\n  \"{base_url}/api/v1/users/12345/export/sleep.csv?days=90\" \\\n  -o sleep_data.csv\n</code></pre></p> <p>Sleep CSV columns: <code>date</code>, <code>sleep_score</code>, <code>total_hours</code>, <code>deep_hours</code>, <code>light_hours</code>, <code>rem_hours</code>, <code>hrv_avg</code>, <code>heart_rate_avg</code>, <code>breathing_rate_avg</code></p> <p>Activity CSV columns: <code>date</code>, <code>steps</code>, <code>calories_active</code>, <code>calories_total</code>, <code>distance_km</code>, <code>active_minutes</code></p> <p>Recharge CSV columns: <code>date</code>, <code>hrv_avg</code>, <code>ans_charge</code>, <code>status</code>, <code>breathing_rate</code>, <code>heart_rate_avg</code></p> <p>Cardio Load CSV columns: <code>date</code>, <code>strain</code>, <code>tolerance</code>, <code>cardio_load</code>, <code>load_ratio</code>, <code>status</code></p>"},{"location":"api/overview/#baselines-analytics","title":"Baselines &amp; Analytics","text":"<p>Personal baselines computed from historical data. Use these for anomaly detection and personalized insights.</p> Method Endpoint Description GET <code>/users/{user_id}/baselines</code> Get all computed baselines GET <code>/users/{user_id}/baselines/{metric_name}</code> Get specific baseline POST <code>/users/{user_id}/baselines/calculate</code> Trigger baseline calculation GET <code>/users/{user_id}/baselines/check/{metric_name}/{value}</code> Check if value is anomalous GET <code>/users/{user_id}/analytics/status</code> Get analytics readiness status <p>Valid Metric Names: - <code>hrv_rmssd</code> - Heart Rate Variability (RMSSD) - <code>sleep_score</code> - Overall sleep quality score - <code>resting_hr</code> - Resting heart rate - <code>training_load</code> - Training load (cardio load) - <code>training_load_ratio</code> - Acute:chronic load ratio</p>"},{"location":"api/overview/#get-all-baselines","title":"Get All Baselines","text":"<pre><code>curl {base_url}/api/v1/users/12345/baselines\n</code></pre> <p>Response: <pre><code>[\n  {\n    \"metric_name\": \"hrv_rmssd\",\n    \"baseline_value\": 42.5,\n    \"baseline_7d\": 44.2,\n    \"baseline_30d\": 41.8,\n    \"baseline_90d\": 40.5,\n    \"median\": 42.0,\n    \"q1\": 38.5,\n    \"q3\": 48.2,\n    \"iqr\": 9.7,\n    \"std_dev\": 8.3,\n    \"min\": 28.0,\n    \"max\": 65.0,\n    \"lower_bound\": 24.0,\n    \"upper_bound\": 62.8,\n    \"sample_count\": 45,\n    \"status\": \"ready\",\n    \"data_start_date\": \"2025-11-01\",\n    \"data_end_date\": \"2026-01-11\",\n    \"calculated_at\": \"2026-01-11T08:00:00Z\"\n  }\n]\n</code></pre></p> <p>Baseline Status: - <code>ready</code> - Full baseline (21+ days of data) - <code>partial</code> - Limited baseline (7-20 days) - <code>insufficient</code> - Not enough data (&lt;7 days)</p>"},{"location":"api/overview/#check-for-anomaly","title":"Check for Anomaly","text":"<p>Uses IQR-based anomaly detection: - Warning: value outside Q1 - 1.5\u00d7IQR to Q3 + 1.5\u00d7IQR - Critical: value outside Q1 - 3\u00d7IQR to Q3 + 3\u00d7IQR</p> <pre><code>curl {base_url}/api/v1/users/12345/baselines/check/hrv_rmssd/25.5\n</code></pre> <p>Response: <pre><code>{\n  \"value\": 25.5,\n  \"metric_name\": \"hrv_rmssd\",\n  \"is_anomaly\": true,\n  \"severity\": \"warning\",\n  \"baseline\": 42.5,\n  \"baseline_7d\": 44.2,\n  \"lower_bound\": 24.0,\n  \"upper_bound\": 62.8,\n  \"status\": \"ready\"\n}\n</code></pre></p>"},{"location":"api/overview/#calculate-baselines","title":"Calculate Baselines","text":"<p>Trigger baseline recalculation from historical data:</p> <pre><code>curl -X POST {base_url}/api/v1/users/12345/baselines/calculate\n</code></pre> <p>Response: <pre><code>{\n  \"user_id\": \"12345\",\n  \"baselines_calculated\": {\n    \"hrv_rmssd\": \"ready\",\n    \"sleep_score\": \"ready\",\n    \"resting_hr\": \"ready\",\n    \"training_load\": \"partial\",\n    \"training_load_ratio\": \"partial\"\n  }\n}\n</code></pre></p>"},{"location":"api/overview/#analytics-status","title":"Analytics Status","text":"<p>Check feature availability based on data history:</p> <pre><code>curl {base_url}/api/v1/users/12345/analytics/status\n</code></pre> <p>Response: <pre><code>{\n  \"user_id\": \"12345\",\n  \"data_days\": {\n    \"sleep\": 45,\n    \"recharge\": 45,\n    \"activity\": 45,\n    \"cardio_load\": 30\n  },\n  \"min_data_days\": 30,\n  \"features_available\": {\n    \"basic_stats\": true,\n    \"trend_analysis\": true,\n    \"personalized_baselines\": true,\n    \"predictive_models\": true,\n    \"advanced_ml\": false,\n    \"long_term_patterns\": false\n  },\n  \"unlock_progress\": {\n    \"advanced_ml\": {\n      \"unlocked\": false,\n      \"days_required\": 60,\n      \"days_remaining\": 30,\n      \"progress_percent\": 50.0\n    }\n  },\n  \"recommendations\": [\n    \"Great progress! Advanced ML features unlock after 60 days of data.\"\n  ]\n}\n</code></pre></p> <p>Feature Unlock Timeline: | Days | Features Unlocked | |------|-------------------| | 7 | Basic statistics, daily tracking | | 14 | Trend analysis, basic anomaly alerts | | 21 | Reliable correlations, personalized baselines | | 30 | Predictive models, outcome forecasting | | 60 | Advanced ML models, behavior patterns | | 90 | Long-term pattern recognition |</p>"},{"location":"api/overview/#patterns-anomalies","title":"Patterns &amp; Anomalies","text":"<p>Advanced pattern detection for correlations, trends, and risk assessment.</p> Method Endpoint Description GET <code>/users/{user_id}/patterns</code> Get all detected patterns GET <code>/users/{user_id}/patterns/{pattern_name}</code> Get specific pattern POST <code>/users/{user_id}/patterns/detect</code> Trigger pattern detection GET <code>/users/{user_id}/anomalies</code> Scan all metrics for anomalies <p>Pattern Types: - <code>correlation</code> - Statistical relationships between metrics - <code>trend</code> - Directional changes over time - <code>composite</code> - Multi-metric risk scores</p> <p>Available Patterns: - <code>sleep_hrv_correlation</code> - Correlation between sleep quality and HRV - <code>overtraining_risk</code> - Multi-metric overtraining risk score (0-100) - <code>hrv_trend</code> - 7-day HRV trend vs 30-day baseline - <code>sleep_trend</code> - 7-day sleep score trend vs 30-day baseline</p>"},{"location":"api/overview/#get-all-patterns","title":"Get All Patterns","text":"<pre><code>curl {base_url}/api/v1/users/12345/patterns\n</code></pre> <p>Response: <pre><code>[\n  {\n    \"pattern_type\": \"correlation\",\n    \"pattern_name\": \"sleep_hrv_correlation\",\n    \"score\": 0.72,\n    \"confidence\": 0.95,\n    \"significance\": \"high\",\n    \"metrics_involved\": [\"sleep_score\", \"hrv_rmssd\"],\n    \"sample_count\": 28,\n    \"details\": {\n      \"correlation_coefficient\": 0.72,\n      \"p_value\": 0.001,\n      \"interpretation\": \"Strong positive correlation between sleep quality and HRV\"\n    },\n    \"analyzed_at\": \"2026-01-13T08:00:00Z\"\n  },\n  {\n    \"pattern_type\": \"composite\",\n    \"pattern_name\": \"overtraining_risk\",\n    \"score\": 35,\n    \"confidence\": 0.88,\n    \"significance\": \"medium\",\n    \"metrics_involved\": [\"hrv_rmssd\", \"sleep_score\", \"resting_hr\", \"training_load_ratio\"],\n    \"sample_count\": 7,\n    \"details\": {\n      \"risk_factors\": [\"HRV trending 8% below baseline\"],\n      \"recommendations\": [\n        \"Monitor your body's response to training\",\n        \"Consider adding an extra recovery day this week\"\n      ]\n    },\n    \"analyzed_at\": \"2026-01-13T08:00:00Z\"\n  }\n]\n</code></pre></p> <p>Significance Levels: - <code>high</code> - Statistically significant pattern (p &lt; 0.01) - <code>medium</code> - Moderate significance (p &lt; 0.05) - <code>low</code> - Weak pattern (p &lt; 0.1) - <code>insufficient</code> - Not enough data for reliable analysis</p>"},{"location":"api/overview/#get-specific-pattern","title":"Get Specific Pattern","text":"<pre><code>curl {base_url}/api/v1/users/12345/patterns/overtraining_risk\n</code></pre>"},{"location":"api/overview/#trigger-pattern-detection","title":"Trigger Pattern Detection","text":"<p>Analyzes historical data and stores pattern results:</p> <pre><code>curl -X POST {base_url}/api/v1/users/12345/patterns/detect\n</code></pre> <p>Response: <pre><code>{\n  \"user_id\": \"12345\",\n  \"patterns_detected\": {\n    \"sleep_hrv_correlation\": \"high\",\n    \"overtraining_risk\": \"medium\",\n    \"hrv_trend\": \"low\",\n    \"sleep_trend\": \"insufficient\"\n  }\n}\n</code></pre></p>"},{"location":"api/overview/#bulk-anomaly-scan","title":"Bulk Anomaly Scan","text":"<p>Scans all metrics against stored baselines and returns any values outside normal bounds:</p> <pre><code>curl {base_url}/api/v1/users/12345/anomalies\n</code></pre> <p>Response: <pre><code>{\n  \"user_id\": \"12345\",\n  \"anomaly_count\": 2,\n  \"anomalies\": [\n    {\n      \"metric_name\": \"hrv_rmssd\",\n      \"current_value\": 22.5,\n      \"baseline_value\": 42.5,\n      \"lower_bound\": 24.0,\n      \"upper_bound\": 62.8,\n      \"severity\": \"critical\",\n      \"direction\": \"below\",\n      \"deviation_percent\": -47.1\n    },\n    {\n      \"metric_name\": \"resting_hr\",\n      \"current_value\": 68,\n      \"baseline_value\": 55,\n      \"lower_bound\": 48,\n      \"upper_bound\": 65,\n      \"severity\": \"warning\",\n      \"direction\": \"above\",\n      \"deviation_percent\": 23.6\n    }\n  ]\n}\n</code></pre></p> <p>Anomaly Severity: - <code>warning</code> - Value outside Q1 - 1.5\u00d7IQR to Q3 + 1.5\u00d7IQR - <code>critical</code> - Value outside Q1 - 3\u00d7IQR to Q3 + 3\u00d7IQR</p>"},{"location":"api/overview/#unified-insights","title":"Unified Insights","text":"<p>The unified insights endpoint aggregates all analytics into a single response optimized for downstream consumers (dashboards, coaching apps, etc.).</p> Method Endpoint Description GET <code>/users/{user_id}/insights</code> Get complete insights package <p>Response includes: - Current metric values - Personal baseline comparisons - Detected patterns (correlations, trends, risk scores) - Anomalies (values outside normal bounds) - Natural language observations - Actionable suggestions - Feature availability based on data history</p>"},{"location":"api/overview/#feature-unlock-timeline","title":"Feature Unlock Timeline","text":"<p>Features unlock progressively as more data becomes available:</p> Days of Data Features Available 0-6 Raw data only, no analytics 7+ 7-day baselines 21+ Pattern detection, anomaly detection 30+ Full 30-day baselines 60+ ML predictions (future)"},{"location":"api/overview/#example-request","title":"Example Request","text":"<pre><code>curl {base_url}/api/v1/users/12345/insights\n</code></pre>"},{"location":"api/overview/#example-response-30-days-of-data","title":"Example Response (30+ days of data)","text":"<pre><code>{\n  \"user_id\": \"12345\",\n  \"generated_at\": \"2026-01-13T10:30:00Z\",\n  \"data_freshness\": \"2026-01-13T06:00:00Z\",\n  \"data_age_days\": 45,\n  \"status\": \"ready\",\n\n  \"feature_availability\": {\n    \"baselines_7d\": {\"available\": true, \"message\": null},\n    \"baselines_30d\": {\"available\": true, \"message\": null},\n    \"patterns\": {\"available\": true, \"message\": null},\n    \"anomaly_detection\": {\"available\": true, \"message\": null},\n    \"ml_predictions\": {\"available\": false, \"message\": \"Unlocks in 15 days\", \"unlock_at_days\": 60}\n  },\n\n  \"unlock_progress\": {\n    \"next_unlock\": \"ml_predictions\",\n    \"days_until_next\": 15,\n    \"percent_to_next\": 75.0\n  },\n\n  \"current_metrics\": {\n    \"hrv\": 45.2,\n    \"sleep_score\": 78,\n    \"resting_hr\": 52,\n    \"training_load_ratio\": 1.1\n  },\n\n  \"baselines\": {\n    \"hrv_rmssd\": {\n      \"current\": 45.2,\n      \"baseline\": 52.0,\n      \"baseline_7d\": 48.5,\n      \"baseline_30d\": 52.0,\n      \"percent_of_baseline\": 86.9,\n      \"trend\": \"declining\",\n      \"status\": \"ready\"\n    },\n    \"sleep_score\": {\n      \"current\": 78,\n      \"baseline\": 82.0,\n      \"percent_of_baseline\": 95.1,\n      \"trend\": \"stable\",\n      \"status\": \"ready\"\n    }\n  },\n\n  \"patterns\": [\n    {\n      \"name\": \"sleep_hrv_correlation\",\n      \"pattern_type\": \"correlation\",\n      \"score\": 0.72,\n      \"significance\": \"high\",\n      \"factors\": [],\n      \"interpretation\": \"Strong positive correlation between sleep quality and HRV\"\n    },\n    {\n      \"name\": \"overtraining_risk\",\n      \"pattern_type\": \"composite\",\n      \"score\": 35,\n      \"significance\": \"medium\",\n      \"factors\": [\"HRV trending below baseline\"],\n      \"interpretation\": null\n    }\n  ],\n\n  \"anomalies\": [],\n\n  \"observations\": [\n    {\n      \"category\": \"recovery\",\n      \"priority\": \"high\",\n      \"fact\": \"HRV is 13% below personal baseline\",\n      \"context\": \"Current: 45ms, Baseline: 52ms\",\n      \"trend\": \"declining\"\n    },\n    {\n      \"category\": \"recovery\",\n      \"priority\": \"info\",\n      \"fact\": \"Strong connection between your sleep quality and HRV detected\",\n      \"context\": \"Better sleep directly improves your recovery metrics\",\n      \"trend\": null\n    }\n  ],\n\n  \"suggestions\": [\n    {\n      \"action\": \"prioritize_recovery\",\n      \"description\": \"Prioritize sleep and recovery today\",\n      \"confidence\": 0.85,\n      \"reason\": \"HRV is 13% below baseline\"\n    }\n  ]\n}\n</code></pre>"},{"location":"api/overview/#example-response-new-user-5-days","title":"Example Response (New User - 5 days)","text":"<pre><code>{\n  \"user_id\": \"12345\",\n  \"generated_at\": \"2026-01-13T10:30:00Z\",\n  \"data_age_days\": 5,\n  \"status\": \"unavailable\",\n\n  \"feature_availability\": {\n    \"baselines_7d\": {\"available\": false, \"message\": \"Unlocks in 2 days\", \"unlock_at_days\": 7},\n    \"baselines_30d\": {\"available\": false, \"message\": \"Unlocks in 25 days\", \"unlock_at_days\": 30},\n    \"patterns\": {\"available\": false, \"message\": \"Unlocks in 16 days\", \"unlock_at_days\": 21},\n    \"anomaly_detection\": {\"available\": false, \"message\": \"Unlocks in 16 days\", \"unlock_at_days\": 21},\n    \"ml_predictions\": {\"available\": false, \"message\": \"Unlocks in 55 days\", \"unlock_at_days\": 60}\n  },\n\n  \"unlock_progress\": {\n    \"next_unlock\": \"baselines_7d\",\n    \"days_until_next\": 2,\n    \"percent_to_next\": 71.4\n  },\n\n  \"current_metrics\": {\n    \"hrv\": 48.0,\n    \"sleep_score\": 75,\n    \"resting_hr\": 55,\n    \"training_load_ratio\": null\n  },\n\n  \"baselines\": {},\n  \"patterns\": [],\n  \"anomalies\": [],\n\n  \"observations\": [\n    {\n      \"category\": \"onboarding\",\n      \"priority\": \"info\",\n      \"fact\": \"Building your personal baselines (5/7 days)\",\n      \"context\": \"Keep wearing your device. Basic insights unlock in 2 days.\",\n      \"trend\": null\n    }\n  ],\n\n  \"suggestions\": []\n}\n</code></pre>"},{"location":"api/overview/#response-fields","title":"Response Fields","text":"Field Description <code>status</code> Overall status: <code>ready</code>, <code>partial</code>, or <code>unavailable</code> <code>data_age_days</code> Number of days of data available <code>feature_availability</code> Which analytics features are unlocked <code>unlock_progress</code> Progress toward unlocking the next feature <code>current_metrics</code> Most recent values of key health metrics <code>baselines</code> Personal baseline comparisons by metric <code>patterns</code> Detected patterns (correlations, trends, risk scores) <code>anomalies</code> Values outside normal IQR bounds <code>observations</code> Natural language observations for coaching <code>suggestions</code> Actionable suggestions based on current state"},{"location":"api/overview/#observation-categories","title":"Observation Categories","text":"Category Description <code>recovery</code> Recovery and HRV-related observations <code>sleep</code> Sleep quality observations <code>training</code> Training load and overtraining observations <code>anomaly</code> Detected anomalies in metrics <code>onboarding</code> New user guidance <code>trend</code> Trend-related observations"},{"location":"api/overview/#observation-priorities","title":"Observation Priorities","text":"Priority Description <code>critical</code> Requires immediate attention <code>high</code> Important observation <code>medium</code> Moderate importance <code>low</code> Minor observation <code>info</code> Informational <code>positive</code> Good news"},{"location":"api/overview/#health","title":"Health","text":"Method Endpoint Description GET <code>/health</code> Server health check <p>Response: <pre><code>{\n  \"status\": \"healthy\",\n  \"database\": \"connected\"\n}\n</code></pre></p>"},{"location":"local/ARCHITECTURE/","title":"Architecture &amp; Design Decisions","text":""},{"location":"local/ARCHITECTURE/#overview","title":"Overview","text":"<p>polar-flow-server is a self-hosted health analytics server for Polar devices, designed to be both: 1. A simple single-user deployment for self-hosters 2. A data analytics engine for a managed SaaS (with Laravel frontend)</p>"},{"location":"local/ARCHITECTURE/#core-philosophy","title":"Core Philosophy","text":"<p>Focus over breadth: We do Polar devices extremely well, not all wearables poorly.</p> <p>Simplicity over features: Clean architecture, minimal dependencies, easy to deploy.</p> <p>Analytics first: We're not just storing data - we're generating insights (HRV baselines, recovery scores, ML predictions).</p> <p>Multi-user from day 1: Same codebase serves both self-hosted and SaaS deployments.</p>"},{"location":"local/ARCHITECTURE/#competitive-analysis-open-wearables-platform","title":"Competitive Analysis: Open Wearables Platform","text":""},{"location":"local/ARCHITECTURE/#what-is-open-wearables","title":"What is Open Wearables?","text":"<p>A multi-provider health data aggregation platform (like Plaid for health data). Self-hosted middleware for app developers to unify Garmin, Polar, Suunto, Whoop, Apple Health data.</p> <p>Tech Stack: - FastAPI + React + TypeScript - PostgreSQL + Redis + Celery - Single-tenant (one deployment per organization) - Developer portal, not user dashboard</p>"},{"location":"local/ARCHITECTURE/#what-they-do-well","title":"What They Do Well","text":"<ol> <li>Provider abstraction - Clean strategy pattern for adding wearables</li> <li>Unified data model - Normalizes workouts/sleep across providers</li> <li>Cursor pagination - Scalable for large datasets</li> <li>Developer portal - API key management, stats</li> <li>Background sync - Celery workers for scheduled tasks</li> <li>Documentation - Mintlify site with guides and examples</li> <li>Test factories - factory-boy for test data generation</li> </ol>"},{"location":"local/ARCHITECTURE/#what-they-do-wrong","title":"What They Do Wrong","text":"<ol> <li>Incomplete implementation - Many endpoints return 501 Not Implemented</li> <li>Single-tenant only - One deployment per organization, not true multi-user SaaS</li> <li>Over-engineered - Celery + Redis + Flower for simple scheduled tasks</li> <li>No analytics - Just data storage, no insights or ML</li> <li>No rate limiting - Open to abuse</li> <li>Poor time-series design - Single table will scale poorly</li> <li>No user authentication - Users managed by API consumers only</li> </ol>"},{"location":"local/ARCHITECTURE/#why-were-different-and-better","title":"Why We're Different (and Better)","text":"Aspect Open Wearables polar-flow-server Scope Multi-provider middleware Polar analytics server Use Case Infrastructure for developers Analytics for end users Multi-user Single-org per deployment True multi-user SaaS ready Analytics None (just storage) HRV baselines, recovery, ML Complexity High (Celery/Redis/Docker) Low (PostgreSQL only) Deployment Self-hosted platform Self-hosted OR managed SaaS Type Safety Experimental <code>ty</code> checker mypy strict mode Test Coverage Unknown 90%+ enforced API Coverage Partial (501s everywhere) Complete Polar V3 API <p>Bottom Line: They're solving a different problem (infrastructure for devs). We're solving analytics for users.</p>"},{"location":"local/ARCHITECTURE/#architecture-decisions","title":"Architecture Decisions","text":""},{"location":"local/ARCHITECTURE/#1-postgresql-only-no-duckdbsqlite","title":"1. PostgreSQL Only (No DuckDB/SQLite)","text":"<p>Decision: Use PostgreSQL for both self-hosted and SaaS deployments.</p> <p>Rationale: - Self-hosted gets docker-compose with Postgres (no hassle) - SaaS shares same Postgres with Laravel - Same database = zero conditional logic in code - Better timeseries support than SQLite - Proper async support (no thread executor wrapping) - Can add indexes on (user_id, date) for fast queries - Multi-user ready out of the box</p> <p>Trade-off: Requires docker-compose for self-hosted (vs embedded DB).</p> <p>Validation: Open Wearables uses PostgreSQL successfully for similar workload.</p>"},{"location":"local/ARCHITECTURE/#2-multi-user-from-day-1","title":"2. Multi-User from Day 1","text":"<p>Decision: Every table includes <code>user_id</code> column, all endpoints scoped by <code>user_id</code>.</p> <p>Rationale: - Self-hosted: one user in database - SaaS: many users in database - Same codebase, no retrofitting later - No multi-tenancy complexity (shared schema, filtered by user_id) - Enables future growth without architectural changes</p> <p>Trade-off: Slightly more complex than assuming single user.</p> <p>Validation: Open Wearables is single-org only - limits their SaaS potential.</p>"},{"location":"local/ARCHITECTURE/#3-python-analytics-engine-laravel-frontend-for-saas","title":"3. Python Analytics Engine + Laravel Frontend (for SaaS)","text":"<p>Decision: Python handles data sync and analytics, Laravel handles UI/auth/billing.</p> <p>Rationale: - Python excels at data processing and ML (Polars, scikit-learn, PyTorch) - PHP/Laravel can't do ML/analytics well - Laravel excels at auth, billing, UI (what you're confident in) - Clean separation of concerns - Laravel calls Python API for data retrieval</p> <p>Implementation: <pre><code>// Laravel example\n$response = Http::get(\"http://python-service:8000/api/v1/users/{$user-&gt;id}/sleep\");\n$sleepData = $response-&gt;json();\n</code></pre></p> <p>Trade-off: Two services instead of one monolith.</p> <p>Validation: Common microservices pattern (auth service + data service).</p>"},{"location":"local/ARCHITECTURE/#4-litestar-over-fastapi","title":"4. Litestar over FastAPI","text":"<p>Decision: Use Litestar async web framework.</p> <p>Rationale: - Modern async framework (like FastAPI but newer) - Built-in dependency injection - Better SQLAlchemy integration - Faster than FastAPI in benchmarks - Active development, good docs</p> <p>Trade-off: Smaller community than FastAPI.</p> <p>Validation: Open Wearables uses FastAPI successfully (similar approach works).</p>"},{"location":"local/ARCHITECTURE/#5-no-celery-apscheduler-instead","title":"5. No Celery (APScheduler Instead)","text":"<p>Decision: Use APScheduler for background sync tasks, not Celery.</p> <p>Rationale: - Celery requires Redis + workers + monitoring - APScheduler runs in-process (simpler deployment) - Good enough for scheduled sync every hour - No distributed task queue needed (not that many users) - Can upgrade to Celery later if needed</p> <p>Trade-off: Can't scale workers horizontally.</p> <p>Validation: Open Wearables uses Celery but has operational complexity we don't need yet.</p>"},{"location":"local/ARCHITECTURE/#6-htmx-admin-panel-not-react","title":"6. HTMX Admin Panel (Not React)","text":"<p>Decision: Build self-hosted admin panel with HTMX, not React.</p> <p>Rationale: - Self-hosters need simple setup wizard and status dashboard - HTMX = server-side rendering, no JavaScript build step - No XSS via JSON parsing - Simpler security model - Plain and functional (not a flashy UI) - Single-user setup on first login (like most open source tools)</p> <p>Trade-off: Less interactive than React SPA.</p> <p>Validation: Many successful self-hosted tools use server-side rendering (Plausible, Umami).</p>"},{"location":"local/ARCHITECTURE/#7-strict-type-safety-mypy-strict-mode","title":"7. Strict Type Safety (mypy strict mode)","text":"<p>Decision: Enforce mypy strict mode in CI.</p> <p>Rationale: - Catches bugs at development time - Self-documenting code - Better IDE support - Industry standard for Python type checking</p> <p>Trade-off: More verbose code (explicit types everywhere).</p> <p>Validation: Open Wearables uses experimental <code>ty</code> - mypy is more mature.</p>"},{"location":"local/ARCHITECTURE/#what-were-building","title":"What We're Building","text":""},{"location":"local/ARCHITECTURE/#phase-1-core-infrastructure-complete","title":"Phase 1: Core Infrastructure \u2705 (COMPLETE)","text":"<ul> <li>[x] Database models with user_id on all tables</li> <li>[x] PostgreSQL database with async SQLAlchemy</li> <li>[x] REST API endpoints scoped by user_id</li> <li>[x] Polar sync service (sleep, recharge, activity, exercises)</li> <li>[x] Docker and docker-compose setup</li> <li>[x] Full CI/CD (tests, lint, security, docs)</li> <li>[x] MkDocs documentation</li> </ul>"},{"location":"local/ARCHITECTURE/#phase-2-admin-panel-in-progress","title":"Phase 2: Admin Panel \ud83d\udd04 (IN PROGRESS)","text":"<p>Why this is next: - Validates entire stack works end-to-end - Visual way to test API endpoints - Useful for self-hosters - Forces us to test sync functionality - Simple first-time setup wizard</p> <p>Features: - [ ] First-time setup wizard (create user, connect Polar) - [ ] Sync status dashboard (last sync, record counts) - [ ] Manual sync trigger button - [ ] Basic data visualization (sleep/HRV last 7 days) - [ ] Settings page (sync interval, etc.)</p> <p>Tech: - HTMX for interactivity - Server-side Jinja2 templates - TailwindCSS for styling (keep it plain) - Litestar template rendering</p>"},{"location":"local/ARCHITECTURE/#phase-3-analytics-engine","title":"Phase 3: Analytics Engine","text":"<p>Why this comes after admin: - Needs working data pipeline first - Admin panel helps validate data quality - Can test analytics in UI</p> <p>Features: - [ ] HRV baseline calculation (7/30/60-day rolling medians) - [ ] Recovery score algorithm (HRV + sleep + ANS charge) - [ ] Sleep debt tracking - [ ] Training load analysis - [ ] Polars for fast data processing - [ ] SQL views for pre-computed metrics</p>"},{"location":"local/ARCHITECTURE/#phase-4-mcp-server-claude-desktop-integration","title":"Phase 4: MCP Server (Claude Desktop Integration)","text":"<p>Why this is later: - Requires working analytics first - Nice-to-have, not core functionality - Can query data via natural language</p> <p>Features: - [ ] MCP server implementation - [ ] Tools for querying user data - [ ] Natural language health insights - [ ] Claude Desktop config example</p>"},{"location":"local/ARCHITECTURE/#phase-5-advanced-features-future","title":"Phase 5: Advanced Features (Future)","text":"<ul> <li>[ ] Background scheduler (APScheduler or Celery)</li> <li>[ ] Webhook support from Polar</li> <li>[ ] Data export (CSV, JSON)</li> <li>[ ] ML predictions (injury risk, recovery time)</li> <li>[ ] API rate limiting</li> <li>[ ] Observability (metrics, tracing)</li> </ul>"},{"location":"local/ARCHITECTURE/#what-were-not-building","title":"What We're NOT Building","text":"<p>Multi-provider support - We're Polar-focused. If we expand later, we'll adopt Open Wearables' provider strategy pattern.</p> <p>Mobile app - SaaS customers get Laravel frontend. Self-hosters use admin panel or API.</p> <p>Social features - No following, sharing, leaderboards. This is personal analytics.</p> <p>Complex auth - Self-hosted is simple. SaaS uses Laravel auth.</p> <p>Distributed workers - APScheduler is enough. Celery if we really need it.</p>"},{"location":"local/ARCHITECTURE/#lessons-from-open-wearables","title":"Lessons from Open Wearables","text":""},{"location":"local/ARCHITECTURE/#steal-these-ideas","title":"Steal These Ideas","text":"<ol> <li>OAuth state management - Store state in Redis with TTL for better security</li> <li>Cursor pagination - For large datasets (when we need it)</li> <li>Provider strategy pattern - If we ever add Garmin/Whoop</li> <li>Test factories - factory-boy for cleaner test data</li> <li>Mintlify docs - Upgrade from MkDocs Material (later)</li> <li>Unified data schemas - If we add multi-provider support</li> </ol>"},{"location":"local/ARCHITECTURE/#avoid-these-mistakes","title":"Avoid These Mistakes","text":"<ol> <li>Incomplete endpoints - Ship working features, not 501s</li> <li>Single-tenant design - We're multi-user from day 1</li> <li>Over-abstraction - Generic repository pattern is overkill</li> <li>Missing rate limiting - Add protection from day 1</li> <li>No analytics - Our differentiator, not just storage</li> <li>Poor time-series design - Consider TimescaleDB extension if needed</li> </ol>"},{"location":"local/ARCHITECTURE/#success-metrics","title":"Success Metrics","text":"<p>Self-hosted deployment: - Time to first data: &lt; 5 minutes (docker-compose up + OAuth) - Disk space: &lt; 100MB for first month of data - Memory: &lt; 512MB RAM - CPU: Negligible (sync runs hourly)</p> <p>SaaS deployment: - Support 1000+ users on single instance - Sync latency: &lt; 30 seconds per user - API response time: &lt; 100ms p95 - Database size: ~10MB per user per year</p> <p>Code quality: - Test coverage: &gt;90% - Type coverage: 100% (mypy strict) - CI green: Always - Docs: Complete and accurate</p>"},{"location":"local/ARCHITECTURE/#tech-stack-summary","title":"Tech Stack Summary","text":"<p>Core: - Python 3.12+ - PostgreSQL 17 - Litestar 2.14+ - SQLAlchemy 2.0 (async) - polar-flow-api 1.1.0</p> <p>Data Processing: - Polars (DataFrames) - NumPy/SciPy (analytics)</p> <p>Background Tasks: - APScheduler (start) - Celery (if needed later)</p> <p>Admin UI: - HTMX - Jinja2 templates - TailwindCSS</p> <p>Development: - uv (package manager) - Ruff (linting/formatting) - mypy (type checking) - pytest (testing)</p> <p>Deployment: - Docker + docker-compose - GitHub Actions (CI/CD) - MkDocs Material (docs)</p>"},{"location":"local/ARCHITECTURE/#conclusion","title":"Conclusion","text":"<p>We're building a focused, well-architected health analytics server for Polar devices. We've learned from Open Wearables (multi-provider platform) but chosen a simpler, more focused approach.</p> <p>Next step: Build HTMX admin panel to validate the entire stack works.</p>"}]}